<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Rook Ceph Documentation"><meta name=author content="Rook Authors"><link href=https://rook.io/latest/Troubleshooting/disaster-recovery/ rel=canonical><link rel=icon href=https://rook.io/images/favicon_192x192.png><meta name=generator content="mkdocs-1.3.0, mkdocs-material-8.2.15"><title>Disaster Recovery - Rook Ceph Documentation</title><link rel=stylesheet href=../../assets/stylesheets/main.c382b1dc.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.cc9b2e1e.min.css><link rel=stylesheet href=../../stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=rook-blue data-md-color-accent=deep-orange> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#restoring-mon-quorum class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <div data-md-component=outdated hidden> <aside class="md-banner md-banner--warning"> <div class="md-banner__inner md-grid md-typeset"> This document is for a development version of Rook. <a href=../latest-release/../..> <strong>Click here to go to latest release documentation.</strong> </a> </div> <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script> </aside> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Rook Ceph Documentation" class="md-header__button md-logo" aria-label="Rook Ceph Documentation" data-md-component=logo> <img src=https://rook.io/images/rook-logo.svg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Rook Ceph Documentation </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Disaster Recovery </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=rook-blue data-md-color-accent=deep-orange aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=rook-blue data-md-color-accent=red aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/rook/rook title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../Getting-Started/intro/ class=md-tabs__link> Getting Started </a> </li> <li class=md-tabs__item> <a href=../../Helm-Charts/helm-charts/ class=md-tabs__link> Helm Charts </a> </li> <li class=md-tabs__item> <a href=../../Storage-Configuration/Block-Storage-RBD/block-storage/ class=md-tabs__link> Storage Configuration </a> </li> <li class=md-tabs__item> <a href=../../CRDs/ceph-cluster-crd/ class=md-tabs__link> Custom Resources </a> </li> <li class=md-tabs__item> <a href=../ceph-toolbox/ class="md-tabs__link md-tabs__link--active"> Troubleshooting </a> </li> <li class=md-tabs__item> <a href=../../Upgrade/health-verification/ class=md-tabs__link> Upgrade </a> </li> <li class=md-tabs__item> <a href=../../Contributing/development-flow/ class=md-tabs__link> Contributing </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Rook Ceph Documentation" class="md-nav__button md-logo" aria-label="Rook Ceph Documentation" data-md-component=logo> <img src=https://rook.io/images/rook-logo.svg alt=logo> </a> Rook Ceph Documentation </label> <div class=md-nav__source> <a href=https://github.com/rook/rook title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 data-md-state=indeterminate type=checkbox id=__nav_1 checked> <label class=md-nav__link for=__nav_1> Getting Started <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Getting Started" data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Getting Started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Getting-Started/intro/ class=md-nav__link> Rook </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_2 data-md-state=indeterminate type=checkbox id=__nav_1_2 checked> <label class=md-nav__link for=__nav_1_2> Prerequisites <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Prerequisites data-md-level=2> <label class=md-nav__title for=__nav_1_2> <span class="md-nav__icon md-icon"></span> Prerequisites </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Getting-Started/Prerequisites/prerequisites/ class=md-nav__link> Prerequisites </a> </li> <li class=md-nav__item> <a href=../../Getting-Started/Prerequisites/authenticated-registry/ class=md-nav__link> Authenticated Container Registries </a> </li> <li class=md-nav__item> <a href=../../Getting-Started/Prerequisites/pod-security-policies/ class=md-nav__link> Pod Security Policies </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../Getting-Started/quickstart/ class=md-nav__link> Quickstart </a> </li> <li class=md-nav__item> <a href=../../Getting-Started/storage-architecture/ class=md-nav__link> Storage Architecture </a> </li> <li class=md-nav__item> <a href=../../Getting-Started/example-configurations/ class=md-nav__link> Example Configurations </a> </li> <li class=md-nav__item> <a href=../../Getting-Started/ceph-openshift/ class=md-nav__link> OpenShift </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 data-md-state=indeterminate type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2> Helm Charts <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Helm Charts" data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Helm Charts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Helm-Charts/helm-charts/ class=md-nav__link> Helm Charts Overview </a> </li> <li class=md-nav__item> <a href=../../Helm-Charts/operator-chart/ class=md-nav__link> Ceph Operator Helm Chart </a> </li> <li class=md-nav__item> <a href=../../Helm-Charts/ceph-cluster-chart/ class=md-nav__link> Ceph Cluster Helm Chart </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 data-md-state=indeterminate type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3> Storage Configuration <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Storage Configuration" data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Storage Configuration </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_1 data-md-state=indeterminate type=checkbox id=__nav_3_1 checked> <label class=md-nav__link for=__nav_3_1> Block Storage (RBD) <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Block Storage (RBD)" data-md-level=2> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> Block Storage (RBD) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Storage-Configuration/Block-Storage-RBD/block-storage/ class=md-nav__link> Block Storage Overview </a> </li> <li class=md-nav__item> <a href=../../Storage-Configuration/Block-Storage-RBD/rbd-mirroring/ class=md-nav__link> RBD Mirroring </a> </li> <li class=md-nav__item> <a href=../../Storage-Configuration/Block-Storage-RBD/rbd-async-disaster-recovery-failover-failback/ class=md-nav__link> RBD Asynchronous DR Failover and Failback </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2 data-md-state=indeterminate type=checkbox id=__nav_3_2 checked> <label class=md-nav__link for=__nav_3_2> Shared Filesystem (CephFS) <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Shared Filesystem (CephFS)" data-md-level=2> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> Shared Filesystem (CephFS) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Storage-Configuration/Shared-Filesystem-CephFS/filesystem-storage/ class=md-nav__link> Filesystem Storage Overview </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3 data-md-state=indeterminate type=checkbox id=__nav_3_3 checked> <label class=md-nav__link for=__nav_3_3> Object Storage (RGW) <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Object Storage (RGW)" data-md-level=2> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> Object Storage (RGW) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Storage-Configuration/Object-Storage-RGW/object-storage/ class=md-nav__link> Object Storage Overview </a> </li> <li class=md-nav__item> <a href=../../Storage-Configuration/Object-Storage-RGW/ceph-object-bucket-claim/ class=md-nav__link> Bucket Claim </a> </li> <li class=md-nav__item> <a href=../../Storage-Configuration/Object-Storage-RGW/ceph-object-bucket-notifications/ class=md-nav__link> Object Bucket Notifications </a> </li> <li class=md-nav__item> <a href=../../Storage-Configuration/Object-Storage-RGW/ceph-object-multisite/ class=md-nav__link> Object Store Multisite </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_4 data-md-state=indeterminate type=checkbox id=__nav_3_4 checked> <label class=md-nav__link for=__nav_3_4> Monitoring <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Monitoring data-md-level=2> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> Monitoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Storage-Configuration/Monitoring/ceph-dashboard/ class=md-nav__link> Ceph Dashboard </a> </li> <li class=md-nav__item> <a href=../../Storage-Configuration/Monitoring/ceph-monitoring/ class=md-nav__link> Prometheus Monitoring </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_5 data-md-state=indeterminate type=checkbox id=__nav_3_5 checked> <label class=md-nav__link for=__nav_3_5> Ceph CSI <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Ceph CSI" data-md-level=2> <label class=md-nav__title for=__nav_3_5> <span class="md-nav__icon md-icon"></span> Ceph CSI </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Storage-Configuration/Ceph-CSI/ceph-csi-drivers/ class=md-nav__link> Ceph CSI Drivers </a> </li> <li class=md-nav__item> <a href=../../Storage-Configuration/Ceph-CSI/ceph-csi-snapshot/ class=md-nav__link> Snapshots </a> </li> <li class=md-nav__item> <a href=../../Storage-Configuration/Ceph-CSI/ceph-csi-volume-clone/ class=md-nav__link> Volume clone </a> </li> <li class=md-nav__item> <a href=../../Storage-Configuration/Ceph-CSI/custom-images/ class=md-nav__link> Custom Images </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../Storage-Configuration/ceph-teardown/ class=md-nav__link> Cleanup </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_7 data-md-state=indeterminate type=checkbox id=__nav_3_7 checked> <label class=md-nav__link for=__nav_3_7> Advanced <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Advanced data-md-level=2> <label class=md-nav__title for=__nav_3_7> <span class="md-nav__icon md-icon"></span> Advanced </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Storage-Configuration/Advanced/ceph-configuration/ class=md-nav__link> Ceph Configuration </a> </li> <li class=md-nav__item> <a href=../../Storage-Configuration/Advanced/configuration/ class=md-nav__link> Configuration </a> </li> <li class=md-nav__item> <a href=../../Storage-Configuration/Advanced/key-management-system/ class=md-nav__link> Key Management System </a> </li> <li class=md-nav__item> <a href=../../Storage-Configuration/Advanced/ceph-osd-mgmt/ class=md-nav__link> Ceph OSD Management </a> </li> <li class=md-nav__item> <a href=../../Storage-Configuration/Advanced/ceph-mon-health/ class=md-nav__link> Monitor Health </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 data-md-state=indeterminate type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4> Custom Resources <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Custom Resources" data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Custom Resources </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../CRDs/ceph-cluster-crd/ class=md-nav__link> Cluster CRD </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2 data-md-state=indeterminate type=checkbox id=__nav_4_2 checked> <label class=md-nav__link for=__nav_4_2> Block Storage <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Block Storage" data-md-level=2> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Block Storage </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../CRDs/Block-Storage/ceph-block-pool-crd/ class=md-nav__link> Block Pool CRD </a> </li> <li class=md-nav__item> <a href=../../CRDs/Block-Storage/ceph-block-pool-rados-namespace-crd/ class=md-nav__link> Block Pool RADOS Namespace CRD </a> </li> <li class=md-nav__item> <a href=../../CRDs/Block-Storage/ceph-rbd-mirror-crd/ class=md-nav__link> RBD Mirror CRD </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3 data-md-state=indeterminate type=checkbox id=__nav_4_3 checked> <label class=md-nav__link for=__nav_4_3> Shared Filesystem <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Shared Filesystem" data-md-level=2> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> Shared Filesystem </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../CRDs/Shared-Filesystem/ceph-filesystem-crd/ class=md-nav__link> Filesystem CRD </a> </li> <li class=md-nav__item> <a href=../../CRDs/Shared-Filesystem/ceph-fs-mirror-crd/ class=md-nav__link> Filesystem Mirror CRD </a> </li> <li class=md-nav__item> <a href=../../CRDs/Shared-Filesystem/ceph-fs-subvolumegroup-crd/ class=md-nav__link> Filesystem SubVolume Group CRD </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_4 data-md-state=indeterminate type=checkbox id=__nav_4_4 checked> <label class=md-nav__link for=__nav_4_4> Object Storage <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Object Storage" data-md-level=2> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> Object Storage </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../CRDs/Object-Storage/ceph-object-store-crd/ class=md-nav__link> Object Store CRD </a> </li> <li class=md-nav__item> <a href=../../CRDs/Object-Storage/ceph-object-store-user-crd/ class=md-nav__link> Object Store User CRD </a> </li> <li class=md-nav__item> <a href=../../CRDs/Object-Storage/ceph-object-multisite-crd/ class=md-nav__link> Object Multisite CRDs </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../CRDs/ceph-client-crd/ class=md-nav__link> Client CRD </a> </li> <li class=md-nav__item> <a href=../../CRDs/ceph-nfs-crd/ class=md-nav__link> NFS Server CRD </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 type=checkbox id=__nav_5 checked> <label class=md-nav__link for=__nav_5> Troubleshooting <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Troubleshooting data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Troubleshooting </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ceph-toolbox/ class=md-nav__link> Toolbox </a> </li> <li class=md-nav__item> <a href=../common-issues/ class=md-nav__link> Common Issues </a> </li> <li class=md-nav__item> <a href=../ceph-common-issues/ class=md-nav__link> Ceph Common Issues </a> </li> <li class=md-nav__item> <a href=../ceph-csi-common-issues/ class=md-nav__link> CSI Common Issues </a> </li> <li class=md-nav__item> <a href=../openshift-common-issues/ class=md-nav__link> OpenShift Common Issues </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Disaster Recovery <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Disaster Recovery </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#restoring-mon-quorum class=md-nav__link> Restoring Mon Quorum </a> <nav class=md-nav aria-label="Restoring Mon Quorum"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#stop-the-operator class=md-nav__link> Stop the operator </a> </li> <li class=md-nav__item> <a href=#inject-a-new-monmap class=md-nav__link> Inject a new monmap </a> </li> <li class=md-nav__item> <a href=#edit-the-rook-configmaps class=md-nav__link> Edit the Rook configmaps </a> </li> <li class=md-nav__item> <a href=#restart-the-mon class=md-nav__link> Restart the mon </a> </li> <li class=md-nav__item> <a href=#restart-the-operator class=md-nav__link> Restart the operator </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#restoring-crds-after-deletion class=md-nav__link> Restoring CRDs After Deletion </a> </li> <li class=md-nav__item> <a href=#adopt-an-existing-rook-ceph-cluster-into-a-new-kubernetes-cluster class=md-nav__link> Adopt an existing Rook Ceph cluster into a new Kubernetes cluster </a> <nav class=md-nav aria-label="Adopt an existing Rook Ceph cluster into a new Kubernetes cluster"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#prerequisites class=md-nav__link> Prerequisites </a> </li> <li class=md-nav__item> <a href=#overview-for-steps-below class=md-nav__link> Overview for Steps below </a> </li> <li class=md-nav__item> <a href=#steps class=md-nav__link> Steps </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#backing-up-and-restoring-a-cluster-based-on-pvcs-into-a-new-kubernetes-cluster class=md-nav__link> Backing up and restoring a cluster based on PVCs into a new Kubernetes cluster </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../direct-tools/ class=md-nav__link> Direct Tools </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 data-md-state=indeterminate type=checkbox id=__nav_6 checked> <label class=md-nav__link for=__nav_6> Upgrade <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Upgrade data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Upgrade </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Upgrade/health-verification/ class=md-nav__link> Health Verification </a> </li> <li class=md-nav__item> <a href=../../Upgrade/rook-upgrade/ class=md-nav__link> Rook Upgrades </a> </li> <li class=md-nav__item> <a href=../../Upgrade/ceph-upgrade/ class=md-nav__link> Ceph Upgrades </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7 data-md-state=indeterminate type=checkbox id=__nav_7 checked> <label class=md-nav__link for=__nav_7> Contributing <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Contributing data-md-level=1> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Contributing </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Contributing/development-flow/ class=md-nav__link> Development Flow </a> </li> <li class=md-nav__item> <a href=../../Contributing/development-environment/ class=md-nav__link> Developer Environment </a> </li> <li class=md-nav__item> <a href=../../Contributing/documentation/ class=md-nav__link> Documentation </a> </li> <li class=md-nav__item> <a href=../../Contributing/storage-providers/ class=md-nav__link> Storage Providers </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#restoring-mon-quorum class=md-nav__link> Restoring Mon Quorum </a> <nav class=md-nav aria-label="Restoring Mon Quorum"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#stop-the-operator class=md-nav__link> Stop the operator </a> </li> <li class=md-nav__item> <a href=#inject-a-new-monmap class=md-nav__link> Inject a new monmap </a> </li> <li class=md-nav__item> <a href=#edit-the-rook-configmaps class=md-nav__link> Edit the Rook configmaps </a> </li> <li class=md-nav__item> <a href=#restart-the-mon class=md-nav__link> Restart the mon </a> </li> <li class=md-nav__item> <a href=#restart-the-operator class=md-nav__link> Restart the operator </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#restoring-crds-after-deletion class=md-nav__link> Restoring CRDs After Deletion </a> </li> <li class=md-nav__item> <a href=#adopt-an-existing-rook-ceph-cluster-into-a-new-kubernetes-cluster class=md-nav__link> Adopt an existing Rook Ceph cluster into a new Kubernetes cluster </a> <nav class=md-nav aria-label="Adopt an existing Rook Ceph cluster into a new Kubernetes cluster"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#prerequisites class=md-nav__link> Prerequisites </a> </li> <li class=md-nav__item> <a href=#overview-for-steps-below class=md-nav__link> Overview for Steps below </a> </li> <li class=md-nav__item> <a href=#steps class=md-nav__link> Steps </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#backing-up-and-restoring-a-cluster-based-on-pvcs-into-a-new-kubernetes-cluster class=md-nav__link> Backing up and restoring a cluster based on PVCs into a new Kubernetes cluster </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/rook/rook/edit/master/Documentation/Troubleshooting/disaster-recovery.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a> <h1>Disaster Recovery</h1> <p>Under extenuating circumstances, steps may be necessary to recover the cluster health. There are several types of recovery addressed in this document.</p> <h2 id=restoring-mon-quorum>Restoring Mon Quorum<a class=headerlink href=#restoring-mon-quorum title="Permanent link">&para;</a></h2> <p>Under extenuating circumstances, the mons may lose quorum. If the mons cannot form quorum again, there is a manual procedure to get the quorum going again. The only requirement is that at least one mon is still healthy. The following steps will remove the unhealthy mons from quorum and allow you to form a quorum again with a single mon, then grow the quorum back to the original size.</p> <p>For example, if you have three mons and lose quorum, you will need to remove the two bad mons from quorum, notify the good mon that it is the only mon in quorum, and then restart the good mon.</p> <h3 id=stop-the-operator>Stop the operator<a class=headerlink href=#stop-the-operator title="Permanent link">&para;</a></h3> <p>First, stop the operator so it will not try to failover the mons while we are modifying the monmap</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1></a><span class=go>kubectl -n rook-ceph scale deployment rook-ceph-operator --replicas=0</span>
</code></pre></div></td></tr></table></div> <h3 id=inject-a-new-monmap>Inject a new monmap<a class=headerlink href=#inject-a-new-monmap title="Permanent link">&para;</a></h3> <div class="admonition warning"> <p class=admonition-title>Warning</p> <p>Injecting a monmap must be done very carefully. If run incorrectly, your cluster could be permanently destroyed.</p> </div> <p>The Ceph monmap keeps track of the mon quorum. We will update the monmap to only contain the healthy mon. In this example, the healthy mon is <code>rook-ceph-mon-b</code>, while the unhealthy mons are <code>rook-ceph-mon-a</code> and <code>rook-ceph-mon-c</code>.</p> <p>Take a backup of the current <code>rook-ceph-mon-b</code> Deployment:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-1-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1></a><span class=go>kubectl -n rook-ceph get deployment rook-ceph-mon-b -o yaml &gt; rook-ceph-mon-b-deployment.yaml</span>
</code></pre></div></td></tr></table></div> <p>Open the file and copy the <code>command</code> and <code>args</code> from the <code>mon</code> container (see <code>containers</code> list). This is needed for the monmap changes. Cleanup the copied <code>command</code> and <code>args</code> fields to form a pastable command. Example:</p> <p>The following parts of the <code>mon</code> container:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-2-1> 1</a></span>
<span class=normal><a href=#__codelineno-2-2> 2</a></span>
<span class=normal><a href=#__codelineno-2-3> 3</a></span>
<span class=normal><a href=#__codelineno-2-4> 4</a></span>
<span class=normal><a href=#__codelineno-2-5> 5</a></span>
<span class=normal><a href=#__codelineno-2-6> 6</a></span>
<span class=normal><a href=#__codelineno-2-7> 7</a></span>
<span class=normal><a href=#__codelineno-2-8> 8</a></span>
<span class=normal><a href=#__codelineno-2-9> 9</a></span>
<span class=normal><a href=#__codelineno-2-10>10</a></span>
<span class=normal><a href=#__codelineno-2-11>11</a></span>
<span class=normal><a href=#__codelineno-2-12>12</a></span>
<span class=normal><a href=#__codelineno-2-13>13</a></span>
<span class=normal><a href=#__codelineno-2-14>14</a></span>
<span class=normal><a href=#__codelineno-2-15>15</a></span>
<span class=normal><a href=#__codelineno-2-16>16</a></span>
<span class=normal><a href=#__codelineno-2-17>17</a></span>
<span class=normal><a href=#__codelineno-2-18>18</a></span>
<span class=normal><a href=#__codelineno-2-19>19</a></span>
<span class=normal><a href=#__codelineno-2-20>20</a></span>
<span class=normal><a href=#__codelineno-2-21>21</a></span>
<span class=normal><a href=#__codelineno-2-22>22</a></span>
<span class=normal><a href=#__codelineno-2-23>23</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1></a><span class="p p-Indicator">[</span><span class=nv>...</span><span class="p p-Indicator">]</span><span class=w></span>
<a id=__codelineno-2-2 name=__codelineno-2-2></a><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w></span>
<a id=__codelineno-2-3 name=__codelineno-2-3></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>args</span><span class=p>:</span><span class=w></span>
<a id=__codelineno-2-4 name=__codelineno-2-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--fsid=41a537f2-f282-428e-989f-a9e07be32e47</span><span class=w></span>
<a id=__codelineno-2-5 name=__codelineno-2-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--keyring=/etc/ceph/keyring-store/keyring</span><span class=w></span>
<a id=__codelineno-2-6 name=__codelineno-2-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--log-to-stderr=true</span><span class=w></span>
<a id=__codelineno-2-7 name=__codelineno-2-7></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--err-to-stderr=true</span><span class=w></span>
<a id=__codelineno-2-8 name=__codelineno-2-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--mon-cluster-log-to-stderr=true</span><span class=w></span>
<a id=__codelineno-2-9 name=__codelineno-2-9></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&#39;--log-stderr-prefix=debug</span><span class=nv> </span><span class=s>&#39;</span><span class=w></span>
<a id=__codelineno-2-10 name=__codelineno-2-10></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--default-log-to-file=false</span><span class=w></span>
<a id=__codelineno-2-11 name=__codelineno-2-11></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--default-mon-cluster-log-to-file=false</span><span class=w></span>
<a id=__codelineno-2-12 name=__codelineno-2-12></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--mon-host=$(ROOK_CEPH_MON_HOST)</span><span class=w></span>
<a id=__codelineno-2-13 name=__codelineno-2-13></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--mon-initial-members=$(ROOK_CEPH_MON_INITIAL_MEMBERS)</span><span class=w></span>
<a id=__codelineno-2-14 name=__codelineno-2-14></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--id=b</span><span class=w></span>
<a id=__codelineno-2-15 name=__codelineno-2-15></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--setuser=ceph</span><span class=w></span>
<a id=__codelineno-2-16 name=__codelineno-2-16></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--setgroup=ceph</span><span class=w></span>
<a id=__codelineno-2-17 name=__codelineno-2-17></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--foreground</span><span class=w></span>
<a id=__codelineno-2-18 name=__codelineno-2-18></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--public-addr=10.100.13.242</span><span class=w></span>
<a id=__codelineno-2-19 name=__codelineno-2-19></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--setuser-match-path=/var/lib/ceph/mon/ceph-b/store.db</span><span class=w></span>
<a id=__codelineno-2-20 name=__codelineno-2-20></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--public-bind-addr=$(ROOK_POD_IP)</span><span class=w></span>
<a id=__codelineno-2-21 name=__codelineno-2-21></a><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w></span>
<a id=__codelineno-2-22 name=__codelineno-2-22></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ceph-mon</span><span class=w></span>
<a id=__codelineno-2-23 name=__codelineno-2-23></a><span class="p p-Indicator">[</span><span class=nv>...</span><span class="p p-Indicator">]</span><span class=w></span>
</code></pre></div></td></tr></table></div> <p>Should be made into a command like this: (<strong>do not copy the example command!</strong>)</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-3-1> 1</a></span>
<span class=normal><a href=#__codelineno-3-2> 2</a></span>
<span class=normal><a href=#__codelineno-3-3> 3</a></span>
<span class=normal><a href=#__codelineno-3-4> 4</a></span>
<span class=normal><a href=#__codelineno-3-5> 5</a></span>
<span class=normal><a href=#__codelineno-3-6> 6</a></span>
<span class=normal><a href=#__codelineno-3-7> 7</a></span>
<span class=normal><a href=#__codelineno-3-8> 8</a></span>
<span class=normal><a href=#__codelineno-3-9> 9</a></span>
<span class=normal><a href=#__codelineno-3-10>10</a></span>
<span class=normal><a href=#__codelineno-3-11>11</a></span>
<span class=normal><a href=#__codelineno-3-12>12</a></span>
<span class=normal><a href=#__codelineno-3-13>13</a></span>
<span class=normal><a href=#__codelineno-3-14>14</a></span>
<span class=normal><a href=#__codelineno-3-15>15</a></span>
<span class=normal><a href=#__codelineno-3-16>16</a></span>
<span class=normal><a href=#__codelineno-3-17>17</a></span>
<span class=normal><a href=#__codelineno-3-18>18</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1></a><span class=go>ceph-mon \</span>
<a id=__codelineno-3-2 name=__codelineno-3-2></a><span class=go>    --fsid=41a537f2-f282-428e-989f-a9e07be32e47 \</span>
<a id=__codelineno-3-3 name=__codelineno-3-3></a><span class=go>    --keyring=/etc/ceph/keyring-store/keyring \</span>
<a id=__codelineno-3-4 name=__codelineno-3-4></a><span class=go>    --log-to-stderr=true \</span>
<a id=__codelineno-3-5 name=__codelineno-3-5></a><span class=go>    --err-to-stderr=true \</span>
<a id=__codelineno-3-6 name=__codelineno-3-6></a><span class=go>    --mon-cluster-log-to-stderr=true \</span>
<a id=__codelineno-3-7 name=__codelineno-3-7></a><span class=go>    --log-stderr-prefix=debug \</span>
<a id=__codelineno-3-8 name=__codelineno-3-8></a><span class=go>    --default-log-to-file=false \</span>
<a id=__codelineno-3-9 name=__codelineno-3-9></a><span class=go>    --default-mon-cluster-log-to-file=false \</span>
<a id=__codelineno-3-10 name=__codelineno-3-10></a><span class=go>    --mon-host=$ROOK_CEPH_MON_HOST \</span>
<a id=__codelineno-3-11 name=__codelineno-3-11></a><span class=go>    --mon-initial-members=$ROOK_CEPH_MON_INITIAL_MEMBERS \</span>
<a id=__codelineno-3-12 name=__codelineno-3-12></a><span class=go>    --id=b \</span>
<a id=__codelineno-3-13 name=__codelineno-3-13></a><span class=go>    --setuser=ceph \</span>
<a id=__codelineno-3-14 name=__codelineno-3-14></a><span class=go>    --setgroup=ceph \</span>
<a id=__codelineno-3-15 name=__codelineno-3-15></a><span class=go>    --foreground \</span>
<a id=__codelineno-3-16 name=__codelineno-3-16></a><span class=go>    --public-addr=10.100.13.242 \</span>
<a id=__codelineno-3-17 name=__codelineno-3-17></a><span class=go>    --setuser-match-path=/var/lib/ceph/mon/ceph-b/store.db \</span>
<a id=__codelineno-3-18 name=__codelineno-3-18></a><span class=go>    --public-bind-addr=$ROOK_POD_IP</span>
</code></pre></div></td></tr></table></div> <p>(be sure to remove the single quotes around the <code>--log-stderr-prefix</code> flag and the parenthesis around the variables being passed ROOK_CEPH_MON_HOST, ROOK_CEPH_MON_INITIAL_MEMBERS and ROOK_POD_IP )</p> <p>Patch the <code>rook-ceph-mon-b</code> Deployment to stop this mon working without deleting the mon pod:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-4-1>1</a></span>
<span class=normal><a href=#__codelineno-4-2>2</a></span>
<span class=normal><a href=#__codelineno-4-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1></a><span class=go>kubectl -n rook-ceph patch deployment rook-ceph-mon-b  --type=&#39;json&#39; -p &#39;[{&quot;op&quot;:&quot;remove&quot;, &quot;path&quot;:&quot;/spec/template/spec/containers/0/livenessProbe&quot;}]&#39;</span>
<a id=__codelineno-4-2 name=__codelineno-4-2></a>
<a id=__codelineno-4-3 name=__codelineno-4-3></a><span class=go>kubectl -n rook-ceph patch deployment rook-ceph-mon-b -p &#39;{&quot;spec&quot;: {&quot;template&quot;: {&quot;spec&quot;: {&quot;containers&quot;: [{&quot;name&quot;: &quot;mon&quot;, &quot;command&quot;: [&quot;sleep&quot;, &quot;infinity&quot;], &quot;args&quot;: []}]}}}}&#39;</span>
</code></pre></div></td></tr></table></div> <p>Connect to the pod of a healthy mon and run the following commands.</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-5-1> 1</a></span>
<span class=normal><a href=#__codelineno-5-2> 2</a></span>
<span class=normal><a href=#__codelineno-5-3> 3</a></span>
<span class=normal><a href=#__codelineno-5-4> 4</a></span>
<span class=normal><a href=#__codelineno-5-5> 5</a></span>
<span class=normal><a href=#__codelineno-5-6> 6</a></span>
<span class=normal><a href=#__codelineno-5-7> 7</a></span>
<span class=normal><a href=#__codelineno-5-8> 8</a></span>
<span class=normal><a href=#__codelineno-5-9> 9</a></span>
<span class=normal><a href=#__codelineno-5-10>10</a></span>
<span class=normal><a href=#__codelineno-5-11>11</a></span>
<span class=normal><a href=#__codelineno-5-12>12</a></span>
<span class=normal><a href=#__codelineno-5-13>13</a></span>
<span class=normal><a href=#__codelineno-5-14>14</a></span>
<span class=normal><a href=#__codelineno-5-15>15</a></span>
<span class=normal><a href=#__codelineno-5-16>16</a></span>
<span class=normal><a href=#__codelineno-5-17>17</a></span>
<span class=normal><a href=#__codelineno-5-18>18</a></span>
<span class=normal><a href=#__codelineno-5-19>19</a></span>
<span class=normal><a href=#__codelineno-5-20>20</a></span>
<span class=normal><a href=#__codelineno-5-21>21</a></span>
<span class=normal><a href=#__codelineno-5-22>22</a></span>
<span class=normal><a href=#__codelineno-5-23>23</a></span>
<span class=normal><a href=#__codelineno-5-24>24</a></span>
<span class=normal><a href=#__codelineno-5-25>25</a></span>
<span class=normal><a href=#__codelineno-5-26>26</a></span>
<span class=normal><a href=#__codelineno-5-27>27</a></span>
<span class=normal><a href=#__codelineno-5-28>28</a></span>
<span class=normal><a href=#__codelineno-5-29>29</a></span>
<span class=normal><a href=#__codelineno-5-30>30</a></span>
<span class=normal><a href=#__codelineno-5-31>31</a></span>
<span class=normal><a href=#__codelineno-5-32>32</a></span>
<span class=normal><a href=#__codelineno-5-33>33</a></span>
<span class=normal><a href=#__codelineno-5-34>34</a></span>
<span class=normal><a href=#__codelineno-5-35>35</a></span>
<span class=normal><a href=#__codelineno-5-36>36</a></span>
<span class=normal><a href=#__codelineno-5-37>37</a></span>
<span class=normal><a href=#__codelineno-5-38>38</a></span>
<span class=normal><a href=#__codelineno-5-39>39</a></span>
<span class=normal><a href=#__codelineno-5-40>40</a></span>
<span class=normal><a href=#__codelineno-5-41>41</a></span>
<span class=normal><a href=#__codelineno-5-42>42</a></span>
<span class=normal><a href=#__codelineno-5-43>43</a></span>
<span class=normal><a href=#__codelineno-5-44>44</a></span>
<span class=normal><a href=#__codelineno-5-45>45</a></span>
<span class=normal><a href=#__codelineno-5-46>46</a></span>
<span class=normal><a href=#__codelineno-5-47>47</a></span>
<span class=normal><a href=#__codelineno-5-48>48</a></span>
<span class=normal><a href=#__codelineno-5-49>49</a></span>
<span class=normal><a href=#__codelineno-5-50>50</a></span>
<span class=normal><a href=#__codelineno-5-51>51</a></span>
<span class=normal><a href=#__codelineno-5-52>52</a></span>
<span class=normal><a href=#__codelineno-5-53>53</a></span>
<span class=normal><a href=#__codelineno-5-54>54</a></span>
<span class=normal><a href=#__codelineno-5-55>55</a></span>
<span class=normal><a href=#__codelineno-5-56>56</a></span>
<span class=normal><a href=#__codelineno-5-57>57</a></span>
<span class=normal><a href=#__codelineno-5-58>58</a></span>
<span class=normal><a href=#__codelineno-5-59>59</a></span>
<span class=normal><a href=#__codelineno-5-60>60</a></span>
<span class=normal><a href=#__codelineno-5-61>61</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1></a><span class=gp>$ </span>kubectl -n rook-ceph <span class=nb>exec</span> -it &lt;mon-pod&gt; bash
<a id=__codelineno-5-2 name=__codelineno-5-2></a><span class=gp># </span><span class=nb>set</span> a few simple variables
<a id=__codelineno-5-3 name=__codelineno-5-3></a><span class=go>cluster_namespace=rook-ceph</span>
<a id=__codelineno-5-4 name=__codelineno-5-4></a><span class=go>good_mon_id=b</span>
<a id=__codelineno-5-5 name=__codelineno-5-5></a><span class=go>monmap_path=/tmp/monmap</span>
<a id=__codelineno-5-6 name=__codelineno-5-6></a>
<a id=__codelineno-5-7 name=__codelineno-5-7></a><span class=gp># </span>extract the monmap to a file, by pasting the ceph mon <span class=nb>command</span>
<a id=__codelineno-5-8 name=__codelineno-5-8></a><span class=gp># </span>from the good mon deployment and adding the
<a id=__codelineno-5-9 name=__codelineno-5-9></a><span class=gp># </span><span class=sb>`</span>--extract-monmap<span class=o>=</span><span class=si>${</span><span class=nv>monmap_path</span><span class=si>}</span><span class=sb>`</span> flag
<a id=__codelineno-5-10 name=__codelineno-5-10></a><span class=go>ceph-mon \</span>
<a id=__codelineno-5-11 name=__codelineno-5-11></a><span class=go>    --fsid=41a537f2-f282-428e-989f-a9e07be32e47 \</span>
<a id=__codelineno-5-12 name=__codelineno-5-12></a><span class=go>    --keyring=/etc/ceph/keyring-store/keyring \</span>
<a id=__codelineno-5-13 name=__codelineno-5-13></a><span class=go>    --log-to-stderr=true \</span>
<a id=__codelineno-5-14 name=__codelineno-5-14></a><span class=go>    --err-to-stderr=true \</span>
<a id=__codelineno-5-15 name=__codelineno-5-15></a><span class=go>    --mon-cluster-log-to-stderr=true \</span>
<a id=__codelineno-5-16 name=__codelineno-5-16></a><span class=go>    --log-stderr-prefix=debug \</span>
<a id=__codelineno-5-17 name=__codelineno-5-17></a><span class=go>    --default-log-to-file=false \</span>
<a id=__codelineno-5-18 name=__codelineno-5-18></a><span class=go>    --default-mon-cluster-log-to-file=false \</span>
<a id=__codelineno-5-19 name=__codelineno-5-19></a><span class=go>    --mon-host=$ROOK_CEPH_MON_HOST \</span>
<a id=__codelineno-5-20 name=__codelineno-5-20></a><span class=go>    --mon-initial-members=$ROOK_CEPH_MON_INITIAL_MEMBERS \</span>
<a id=__codelineno-5-21 name=__codelineno-5-21></a><span class=go>    --id=b \</span>
<a id=__codelineno-5-22 name=__codelineno-5-22></a><span class=go>    --setuser=ceph \</span>
<a id=__codelineno-5-23 name=__codelineno-5-23></a><span class=go>    --setgroup=ceph \</span>
<a id=__codelineno-5-24 name=__codelineno-5-24></a><span class=go>    --foreground \</span>
<a id=__codelineno-5-25 name=__codelineno-5-25></a><span class=go>    --public-addr=10.100.13.242 \</span>
<a id=__codelineno-5-26 name=__codelineno-5-26></a><span class=go>    --setuser-match-path=/var/lib/ceph/mon/ceph-b/store.db \</span>
<a id=__codelineno-5-27 name=__codelineno-5-27></a><span class=go>    --public-bind-addr=$ROOK_POD_IP \</span>
<a id=__codelineno-5-28 name=__codelineno-5-28></a><span class=go>    --extract-monmap=${monmap_path}</span>
<a id=__codelineno-5-29 name=__codelineno-5-29></a>
<a id=__codelineno-5-30 name=__codelineno-5-30></a><span class=gp># </span>review the contents of the monmap
<a id=__codelineno-5-31 name=__codelineno-5-31></a><span class=go>monmaptool --print /tmp/monmap</span>
<a id=__codelineno-5-32 name=__codelineno-5-32></a>
<a id=__codelineno-5-33 name=__codelineno-5-33></a><span class=gp># </span>remove the bad mon<span class=o>(</span>s<span class=o>)</span> from the monmap
<a id=__codelineno-5-34 name=__codelineno-5-34></a><span class=go>monmaptool ${monmap_path} --rm &lt;bad_mon&gt;</span>
<a id=__codelineno-5-35 name=__codelineno-5-35></a>
<a id=__codelineno-5-36 name=__codelineno-5-36></a><span class=gp># </span><span class=k>in</span> this example we remove mon0 and mon2:
<a id=__codelineno-5-37 name=__codelineno-5-37></a><span class=go>monmaptool ${monmap_path} --rm a</span>
<a id=__codelineno-5-38 name=__codelineno-5-38></a><span class=go>monmaptool ${monmap_path} --rm c</span>
<a id=__codelineno-5-39 name=__codelineno-5-39></a>
<a id=__codelineno-5-40 name=__codelineno-5-40></a><span class=gp># </span>inject the modified monmap into the good mon, by pasting
<a id=__codelineno-5-41 name=__codelineno-5-41></a><span class=gp># </span>the ceph mon <span class=nb>command</span> and adding the
<a id=__codelineno-5-42 name=__codelineno-5-42></a><span class=gp># </span><span class=sb>`</span>--inject-monmap<span class=o>=</span><span class=si>${</span><span class=nv>monmap_path</span><span class=si>}</span><span class=sb>`</span> flag, like this
<a id=__codelineno-5-43 name=__codelineno-5-43></a><span class=go>ceph-mon \</span>
<a id=__codelineno-5-44 name=__codelineno-5-44></a><span class=go>    --fsid=41a537f2-f282-428e-989f-a9e07be32e47 \</span>
<a id=__codelineno-5-45 name=__codelineno-5-45></a><span class=go>    --keyring=/etc/ceph/keyring-store/keyring \</span>
<a id=__codelineno-5-46 name=__codelineno-5-46></a><span class=go>    --log-to-stderr=true \</span>
<a id=__codelineno-5-47 name=__codelineno-5-47></a><span class=go>    --err-to-stderr=true \</span>
<a id=__codelineno-5-48 name=__codelineno-5-48></a><span class=go>    --mon-cluster-log-to-stderr=true \</span>
<a id=__codelineno-5-49 name=__codelineno-5-49></a><span class=go>    --log-stderr-prefix=debug \</span>
<a id=__codelineno-5-50 name=__codelineno-5-50></a><span class=go>    --default-log-to-file=false \</span>
<a id=__codelineno-5-51 name=__codelineno-5-51></a><span class=go>    --default-mon-cluster-log-to-file=false \</span>
<a id=__codelineno-5-52 name=__codelineno-5-52></a><span class=go>    --mon-host=$ROOK_CEPH_MON_HOST \</span>
<a id=__codelineno-5-53 name=__codelineno-5-53></a><span class=go>    --mon-initial-members=$ROOK_CEPH_MON_INITIAL_MEMBERS \</span>
<a id=__codelineno-5-54 name=__codelineno-5-54></a><span class=go>    --id=b \</span>
<a id=__codelineno-5-55 name=__codelineno-5-55></a><span class=go>    --setuser=ceph \</span>
<a id=__codelineno-5-56 name=__codelineno-5-56></a><span class=go>    --setgroup=ceph \</span>
<a id=__codelineno-5-57 name=__codelineno-5-57></a><span class=go>    --foreground \</span>
<a id=__codelineno-5-58 name=__codelineno-5-58></a><span class=go>    --public-addr=10.100.13.242 \</span>
<a id=__codelineno-5-59 name=__codelineno-5-59></a><span class=go>    --setuser-match-path=/var/lib/ceph/mon/ceph-b/store.db \</span>
<a id=__codelineno-5-60 name=__codelineno-5-60></a><span class=go>    --public-bind-addr=$ROOK_POD_IP \</span>
<a id=__codelineno-5-61 name=__codelineno-5-61></a><span class=go>    --inject-monmap=${monmap_path}</span>
</code></pre></div></td></tr></table></div> <p>Exit the shell to continue.</p> <h3 id=edit-the-rook-configmaps>Edit the Rook configmaps<a class=headerlink href=#edit-the-rook-configmaps title="Permanent link">&para;</a></h3> <p>Edit the configmap that the operator uses to track the mons.</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-6-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1></a><span class=go>kubectl -n rook-ceph edit configmap rook-ceph-mon-endpoints</span>
</code></pre></div></td></tr></table></div> <p>In the <code>data</code> element you will see three mons such as the following (or more depending on your <code>moncount</code>):</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-7-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1></a><span class=nt>data</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">a=10.100.35.200:6789;b=10.100.13.242:6789;c=10.100.35.12:6789</span><span class=w></span>
</code></pre></div></td></tr></table></div> <p>Delete the bad mons from the list, for example to end up with a single good mon:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-8-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1></a><span class=nt>data</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">b=10.100.13.242:6789</span><span class=w></span>
</code></pre></div></td></tr></table></div> <p>Save the file and exit.</p> <p>Now we need to adapt a Secret which is used for the mons and other components. The following <code>kubectl patch</code> command is an easy way to do that. In the end it patches the <code>rook-ceph-config</code> secret and updates the two key/value pairs <code>mon_host</code> and <code>mon_initial_members</code>.</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-9-1>1</a></span>
<span class=normal><a href=#__codelineno-9-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1></a><span class=go>mon_host=$(kubectl -n rook-ceph get svc rook-ceph-mon-b -o jsonpath=&#39;{.spec.clusterIP}&#39;)</span>
<a id=__codelineno-9-2 name=__codelineno-9-2></a><span class=go>kubectl -n rook-ceph patch secret rook-ceph-config -p &#39;{&quot;stringData&quot;: {&quot;mon_host&quot;: &quot;[v2:&#39;&quot;${mon_host}&quot;&#39;:3300,v1:&#39;&quot;${mon_host}&quot;&#39;:6789]&quot;, &quot;mon_initial_members&quot;: &quot;&#39;&quot;${good_mon_id}&quot;&#39;&quot;}}&#39;</span>
</code></pre></div></td></tr></table></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>If you are using <code>hostNetwork: true</code>, you need to replace the <code>mon_host</code> var with the node IP the mon is pinned to (<code>nodeSelector</code>). This is because there is no <code>rook-ceph-mon-*</code> service created in that "mode".</p> </div> <h3 id=restart-the-mon>Restart the mon<a class=headerlink href=#restart-the-mon title="Permanent link">&para;</a></h3> <p>You will need to "restart" the good mon pod with the original <code>ceph-mon</code> command to pick up the changes. For this run <code>kubectl replace</code> on the backup of the mon deployment yaml:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-10-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1></a><span class=go>kubectl replace --force -f rook-ceph-mon-b-deployment.yaml</span>
</code></pre></div></td></tr></table></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Option <code>--force</code> will delete the deployment and create a new one</p> </div> <p>Start the rook <a href=/Documentation/ceph-toolbox.md>toolbox</a> and verify the status of the cluster.</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-11-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1></a><span class=go>ceph -s</span>
</code></pre></div></td></tr></table></div> <p>The status should show one mon in quorum. If the status looks good, your cluster should be healthy again.</p> <h3 id=restart-the-operator>Restart the operator<a class=headerlink href=#restart-the-operator title="Permanent link">&para;</a></h3> <p>Start the rook operator again to resume monitoring the health of the cluster.</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-12-1>1</a></span>
<span class=normal><a href=#__codelineno-12-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1></a><span class=gp># </span>create the operator. it is safe to ignore the errors that a number of resources already exist.
<a id=__codelineno-12-2 name=__codelineno-12-2></a><span class=go>kubectl -n rook-ceph scale deployment rook-ceph-operator --replicas=1</span>
</code></pre></div></td></tr></table></div> <p>The operator will automatically add more mons to increase the quorum size again, depending on the <code>mon.count</code>.</p> <h2 id=restoring-crds-after-deletion>Restoring CRDs After Deletion<a class=headerlink href=#restoring-crds-after-deletion title="Permanent link">&para;</a></h2> <p>When the Rook CRDs are deleted, the Rook operator will respond to the deletion event to attempt to clean up the cluster resources. If any data appears present in the cluster, Rook will refuse to allow the resources to be deleted since the operator will refuse to remove the finalizer on the CRs until the underlying data is deleted. For more details, see the <a href=https://github.com/rook/rook/blob/fix_docs_latest_release/design/ceph/resource-dependencies.md>dependency design doc</a>.</p> <p>While it is good that the CRs will not be deleted and the underlying Ceph data and daemons continue to be available, the CRs will be stuck indefinitely in a <code>Deleting</code> state in which the operator will not continue to ensure cluster health. Upgrades will be blocked, further updates to the CRs are prevented, and so on. Since Kubernetes does not allow undeleting resources, the following procedure will allow you to restore the CRs to their prior state without even necessarily suffering cluster downtime.</p> <ol> <li>Scale down the operator</li> </ol> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-13-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1></a><span class=go>kubectl -n rook-ceph scale --replicas=0 deploy/rook-ceph-operator</span>
</code></pre></div></td></tr></table></div> <ol> <li>Backup all Rook CRs and critical metadata</li> </ol> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-14-1>1</a></span>
<span class=normal><a href=#__codelineno-14-2>2</a></span>
<span class=normal><a href=#__codelineno-14-3>3</a></span>
<span class=normal><a href=#__codelineno-14-4>4</a></span>
<span class=normal><a href=#__codelineno-14-5>5</a></span>
<span class=normal><a href=#__codelineno-14-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1></a><span class=gp># </span>Store the CephCluster CR settings. Also, save other Rook CRs that are <span class=k>in</span> terminating state.
<a id=__codelineno-14-2 name=__codelineno-14-2></a><span class=go>kubectl -n rook-ceph get cephcluster rook-ceph -o yaml &gt; cluster.yaml</span>
<a id=__codelineno-14-3 name=__codelineno-14-3></a>
<a id=__codelineno-14-4 name=__codelineno-14-4></a><span class=gp># </span>Backup critical secrets and configmaps <span class=k>in</span> <span class=k>case</span> something goes wrong later <span class=k>in</span> the procedure
<a id=__codelineno-14-5 name=__codelineno-14-5></a><span class=go>kubectl -n rook-ceph get secret -o yaml &gt; secrets.yaml</span>
<a id=__codelineno-14-6 name=__codelineno-14-6></a><span class=go>kubectl -n rook-ceph get configmap -o yaml &gt; configmaps.yaml</span>
</code></pre></div></td></tr></table></div> <ol> <li>Remove the owner references from all critical Rook resources that were referencing the CephCluster CR. The critical resources include:</li> <li>Secrets: <code>rook-ceph-admin-keyring</code>, <code>rook-ceph-config</code>, <code>rook-ceph-mon</code>, <code>rook-ceph-mons-keyring</code></li> <li>ConfigMap: <code>rook-ceph-mon-endpoints</code></li> <li>Services: <code>rook-ceph-mon-*</code>, <code>rook-ceph-mgr-*</code></li> <li>Deployments: <code>rook-ceph-mon-*</code>, <code>rook-ceph-osd-*</code>, <code>rook-ceph-mgr-*</code></li> <li>PVCs (if applicable): <code>rook-ceph-mon-*</code> and the OSD PVCs (named <code>&lt;deviceset&gt;-*</code>, for example <code>set1-data-*</code>)</li> </ol> <p>For example, remove this entire block from each resource:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-15-1>1</a></span>
<span class=normal><a href=#__codelineno-15-2>2</a></span>
<span class=normal><a href=#__codelineno-15-3>3</a></span>
<span class=normal><a href=#__codelineno-15-4>4</a></span>
<span class=normal><a href=#__codelineno-15-5>5</a></span>
<span class=normal><a href=#__codelineno-15-6>6</a></span>
<span class=normal><a href=#__codelineno-15-7>7</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1></a><span class=nt>ownerReferences</span><span class=p>:</span><span class=w></span>
<a id=__codelineno-15-2 name=__codelineno-15-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ceph.rook.io/v1</span><span class=w></span>
<a id=__codelineno-15-3 name=__codelineno-15-3></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">blockOwnerDeletion</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
<a id=__codelineno-15-4 name=__codelineno-15-4></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">controller</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
<a id=__codelineno-15-5 name=__codelineno-15-5></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">CephCluster</span><span class=w></span>
<a id=__codelineno-15-6 name=__codelineno-15-6></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rook-ceph</span><span class=w></span>
<a id=__codelineno-15-7 name=__codelineno-15-7></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">uid</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;uid&gt;</span><span class=w></span>
</code></pre></div></td></tr></table></div> <ol> <li><strong>After confirming all critical resources have had the owner reference to the CephCluster CR removed</strong>, now we allow the cluster CR to be deleted. Remove the finalizer by editing the CephCluster CR.</li> </ol> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-16-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1></a><span class=go>kubectl -n rook-ceph edit cephcluster</span>
</code></pre></div></td></tr></table></div> <p>For example, remove the following from the CR metadata:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-17-1>1</a></span>
<span class=normal><a href=#__codelineno-17-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1></a><span class=w>    </span><span class=nt>finalizers</span><span class=p>:</span><span class=w></span>
<a id=__codelineno-17-2 name=__codelineno-17-2></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cephcluster.ceph.rook.io</span><span class=w></span>
</code></pre></div></td></tr></table></div> <p>After the finalizer is removed, the CR will be immediately deleted. If all owner references were properly removed, all ceph daemons will continue running and there will be no downtime.</p> <ol> <li>Create the CephCluster CR with the same settings as previously</li> </ol> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-18-1>1</a></span>
<span class=normal><a href=#__codelineno-18-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1></a><span class=gp># </span>Use the same cluster settings as exported above <span class=k>in</span> step <span class=m>2</span>.
<a id=__codelineno-18-2 name=__codelineno-18-2></a><span class=go>kubectl create -f cluster.yaml</span>
</code></pre></div></td></tr></table></div> <ol> <li>If there are other CRs in terminating state such as CephBlockPools, CephObjectStores, or CephFilesystems, follow the above steps as well for those CRs:</li> <li>Backup the CR</li> <li>Remove the finalizer and confirm the CR is deleted (the underlying Ceph resources will be preserved)</li> <li> <p>Create the CR again</p> </li> <li> <p>Scale up the operator</p> </li> </ol> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-19-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1></a><span class=go>kubectl -n rook-ceph scale --replicas=1 deploy/rook-ceph-operator</span>
</code></pre></div></td></tr></table></div> <p>Watch the operator log to confirm that the reconcile completes successfully.</p> <h2 id=adopt-an-existing-rook-ceph-cluster-into-a-new-kubernetes-cluster>Adopt an existing Rook Ceph cluster into a new Kubernetes cluster<a class=headerlink href=#adopt-an-existing-rook-ceph-cluster-into-a-new-kubernetes-cluster title="Permanent link">&para;</a></h2> <p>Situations this section can help resolve:</p> <ol> <li>The Kubernetes environment underlying a running Rook Ceph cluster failed catastrophically, requiring a new Kubernetes environment in which the user wishes to recover the previous Rook Ceph cluster.</li> <li>The user wishes to migrate their existing Rook Ceph cluster to a new Kubernetes environment, and downtime can be tolerated.</li> </ol> <h3 id=prerequisites>Prerequisites<a class=headerlink href=#prerequisites title="Permanent link">&para;</a></h3> <ol> <li>A working Kubernetes cluster to which we will migrate the previous Rook Ceph cluster.</li> <li>At least one Ceph mon db is in quorum, and sufficient number of Ceph OSD is <code>up</code> and <code>in</code> before disaster.</li> <li>The previous Rook Ceph cluster is not running.</li> </ol> <h3 id=overview-for-steps-below>Overview for Steps below<a class=headerlink href=#overview-for-steps-below title="Permanent link">&para;</a></h3> <ol> <li>Start a new and clean Rook Ceph cluster, with old <code>CephCluster</code> <code>CephBlockPool</code> <code>CephFilesystem</code> <code>CephNFS</code> <code>CephObjectStore</code>.</li> <li>Shut the new cluster down when it has been created successfully.</li> <li>Replace ceph-mon data with that of the old cluster.</li> <li>Replace <code>fsid</code> in <code>secrets/rook-ceph-mon</code> with that of the old one.</li> <li>Fix monmap in ceph-mon db.</li> <li>Fix ceph mon auth key.</li> <li>Disable auth.</li> <li>Start the new cluster, watch it resurrect.</li> <li>Fix admin auth key, and enable auth.</li> <li>Restart cluster for the final time.</li> </ol> <h3 id=steps>Steps<a class=headerlink href=#steps title="Permanent link">&para;</a></h3> <p>Assuming <code>dataHostPathData</code> is <code>/var/lib/rook</code>, and the <code>CephCluster</code> trying to adopt is named <code>rook-ceph</code>.</p> <ol> <li>Make sure the old Kubernetes cluster is completely torn down and the new Kubernetes cluster is up and running without Rook Ceph.</li> <li>Backup <code>/var/lib/rook</code> in all the Rook Ceph nodes to a different directory. Backups will be used later.</li> <li>Pick a <code>/var/lib/rook/rook-ceph/rook-ceph.config</code> from any previous Rook Ceph node and save the old cluster <code>fsid</code> from its content.</li> <li>Remove <code>/var/lib/rook</code> from all the Rook Ceph nodes.</li> <li>Add identical <code>CephCluster</code> descriptor to the new Kubernetes cluster, especially identical <code>spec.storage.config</code> and <code>spec.storage.nodes</code>, except <code>mon.count</code>, which should be set to <code>1</code>.</li> <li>Add identical <code>CephFilesystem</code> <code>CephBlockPool</code> <code>CephNFS</code> <code>CephObjectStore</code> descriptors (if any) to the new Kubernetes cluster.</li> <li>Install Rook Ceph in the new Kubernetes cluster.</li> <li>Watch the operator logs with <code>kubectl -n rook-ceph logs -f rook-ceph-operator-xxxxxxx</code>, and wait until the orchestration has settled.</li> <li><strong>STATE</strong>: Now the cluster will have <code>rook-ceph-mon-a</code>, <code>rook-ceph-mgr-a</code>, and all the auxiliary pods up and running, and zero (hopefully) <code>rook-ceph-osd-ID-xxxxxx</code> running. <code>ceph -s</code> output should report 1 mon, 1 mgr running, and all of the OSDs down, all PGs are in <code>unknown</code> state. Rook should not start any OSD daemon since all devices belongs to the old cluster (which have a different <code>fsid</code>).</li> <li> <p>Run <code>kubectl -n rook-ceph exec -it rook-ceph-mon-a-xxxxxxxx bash</code> to enter the <code>rook-ceph-mon-a</code> pod,</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-20-1>1</a></span>
<span class=normal><a href=#__codelineno-20-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1></a><span class=go>mon-a# cat /etc/ceph/keyring-store/keyring  # save this keyring content for later use</span>
<a id=__codelineno-20-2 name=__codelineno-20-2></a><span class=go>mon-a# exit</span>
</code></pre></div></td></tr></table></div> </li> <li> <p>Stop the Rook operator by running <code>kubectl -n rook-ceph edit deploy/rook-ceph-operator</code> and set <code>replicas</code> to <code>0</code>.</p> </li> <li>Stop cluster daemons by running <code>kubectl -n rook-ceph delete deploy/X</code> where X is every deployment in namespace <code>rook-ceph</code>, except <code>rook-ceph-operator</code> and <code>rook-ceph-tools</code>.</li> <li> <p>Save the <code>rook-ceph-mon-a</code> address with <code>kubectl -n rook-ceph get cm/rook-ceph-mon-endpoints -o yaml</code> in the new Kubernetes cluster for later use.</p> </li> <li> <p>SSH to the host where <code>rook-ceph-mon-a</code> in the new Kubernetes cluster resides.</p> <ol> <li>Remove <code>/var/lib/rook/mon-a</code></li> <li>Pick a healthy <code>rook-ceph-mon-ID</code> directory (<code>/var/lib/rook/mon-ID</code>) in the previous backup, copy to <code>/var/lib/rook/mon-a</code>. <code>ID</code> is any healthy mon node ID of the old cluster.</li> <li>Replace <code>/var/lib/rook/mon-a/keyring</code> with the saved keyring, preserving only the <code>[mon.]</code> section, remove <code>[client.admin]</code> section.</li> <li> <p>Run <code>docker run -it --rm -v /var/lib/rook:/var/lib/rook ceph/ceph:v14.2.1-20190430 bash</code>. The Docker image tag should match the Ceph version used in the Rook cluster. The <code>/etc/ceph/ceph.conf</code> file needs to exist for <code>ceph-mon</code> to work.</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-21-1> 1</a></span>
<span class=normal><a href=#__codelineno-21-2> 2</a></span>
<span class=normal><a href=#__codelineno-21-3> 3</a></span>
<span class=normal><a href=#__codelineno-21-4> 4</a></span>
<span class=normal><a href=#__codelineno-21-5> 5</a></span>
<span class=normal><a href=#__codelineno-21-6> 6</a></span>
<span class=normal><a href=#__codelineno-21-7> 7</a></span>
<span class=normal><a href=#__codelineno-21-8> 8</a></span>
<span class=normal><a href=#__codelineno-21-9> 9</a></span>
<span class=normal><a href=#__codelineno-21-10>10</a></span>
<span class=normal><a href=#__codelineno-21-11>11</a></span>
<span class=normal><a href=#__codelineno-21-12>12</a></span>
<span class=normal><a href=#__codelineno-21-13>13</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1></a><span class=go>touch /etc/ceph/ceph.conf</span>
<a id=__codelineno-21-2 name=__codelineno-21-2></a><span class=go>cd /var/lib/rook</span>
<a id=__codelineno-21-3 name=__codelineno-21-3></a><span class=go>ceph-mon --extract-monmap monmap --mon-data ./mon-a/data  # Extract monmap from old ceph-mon db and save as monmap</span>
<a id=__codelineno-21-4 name=__codelineno-21-4></a><span class=go>monmaptool --print monmap  # Print the monmap content, which reflects the old cluster ceph-mon configuration.</span>
<a id=__codelineno-21-5 name=__codelineno-21-5></a><span class=go>monmaptool --rm a monmap  # Delete `a` from monmap.</span>
<a id=__codelineno-21-6 name=__codelineno-21-6></a><span class=go>monmaptool --rm b monmap  # Repeat, and delete `b` from monmap.</span>
<a id=__codelineno-21-7 name=__codelineno-21-7></a><span class=go>monmaptool --rm c monmap  # Repeat this pattern until all the old ceph-mons are removed</span>
<a id=__codelineno-21-8 name=__codelineno-21-8></a><span class=go>monmaptool --rm d monmap</span>
<a id=__codelineno-21-9 name=__codelineno-21-9></a><span class=go>monmaptool --rm e monmap</span>
<a id=__codelineno-21-10 name=__codelineno-21-10></a><span class=go>monmaptool --addv a [v2:10.77.2.216:3300,v1:10.77.2.216:6789] monmap   # Replace it with the rook-ceph-mon-a address you got from previous command.</span>
<a id=__codelineno-21-11 name=__codelineno-21-11></a><span class=go>ceph-mon --inject-monmap monmap --mon-data ./mon-a/data  # Replace monmap in ceph-mon db with our modified version.</span>
<a id=__codelineno-21-12 name=__codelineno-21-12></a><span class=go>rm monmap</span>
<a id=__codelineno-21-13 name=__codelineno-21-13></a><span class=go>exit</span>
</code></pre></div></td></tr></table></div> </li> </ol> </li> <li> <p>Tell Rook to run as old cluster by running <code>kubectl -n rook-ceph edit secret/rook-ceph-mon</code> and changing <code>fsid</code> to the original <code>fsid</code>. Note that the <code>fsid</code> is base64 encoded and must not contain a trailing carriage return. For example:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-22-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1></a><span class=go>echo -n a811f99a-d865-46b7-8f2c-f94c064e4356 | base64  # Replace with the fsid from your old cluster.</span>
</code></pre></div></td></tr></table></div> </li> <li> <p>Disable authentication by running <code>kubectl -n rook-ceph edit cm/rook-config-override</code> and adding content below:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-23-1>1</a></span>
<span class=normal><a href=#__codelineno-23-2>2</a></span>
<span class=normal><a href=#__codelineno-23-3>3</a></span>
<span class=normal><a href=#__codelineno-23-4>4</a></span>
<span class=normal><a href=#__codelineno-23-5>5</a></span>
<span class=normal><a href=#__codelineno-23-6>6</a></span>
<span class=normal><a href=#__codelineno-23-7>7</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1></a><span class=nt>data</span><span class=p>:</span><span class=w></span>
<a id=__codelineno-23-2 name=__codelineno-23-2></a><span class=nt>config</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|</span><span class=w></span>
<a id=__codelineno-23-3 name=__codelineno-23-3></a><span class=w>    </span><span class=no>[global]</span><span class=w></span>
<a id=__codelineno-23-4 name=__codelineno-23-4></a><span class=w>    </span><span class=no>auth cluster required = none</span><span class=w></span>
<a id=__codelineno-23-5 name=__codelineno-23-5></a><span class=w>    </span><span class=no>auth service required = none</span><span class=w></span>
<a id=__codelineno-23-6 name=__codelineno-23-6></a><span class=w>    </span><span class=no>auth client required = none</span><span class=w></span>
<a id=__codelineno-23-7 name=__codelineno-23-7></a><span class=w>    </span><span class=no>auth supported = none</span><span class=w></span>
</code></pre></div></td></tr></table></div> </li> <li> <p>Bring the Rook Ceph operator back online by running <code>kubectl -n rook-ceph edit deploy/rook-ceph-operator</code> and set <code>replicas</code> to <code>1</code>.</p> </li> <li>Watch the operator logs with <code>kubectl -n rook-ceph logs -f rook-ceph-operator-xxxxxxx</code>, and wait until the orchestration has settled.</li> <li><strong>STATE</strong>: Now the new cluster should be up and running with authentication disabled. <code>ceph -s</code> should report 1 mon &amp; 1 mgr &amp; all of the OSDs up and running, and all PGs in either <code>active</code> or <code>degraded</code> state.</li> <li> <p>Run <code>kubectl -n rook-ceph exec -it rook-ceph-tools-XXXXXXX bash</code> to enter tools pod:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-24-1>1</a></span>
<span class=normal><a href=#__codelineno-24-2>2</a></span>
<span class=normal><a href=#__codelineno-24-3>3</a></span>
<span class=normal><a href=#__codelineno-24-4>4</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-24-1 name=__codelineno-24-1></a><span class=go>vi key</span>
<a id=__codelineno-24-2 name=__codelineno-24-2></a><span class=gp># </span><span class=o>[</span>paste keyring content saved before, preserving only <span class=sb>`</span><span class=o>[</span>client admin<span class=o>]</span><span class=sb>`</span> section<span class=o>]</span>
<a id=__codelineno-24-3 name=__codelineno-24-3></a><span class=go>ceph auth import -i key</span>
<a id=__codelineno-24-4 name=__codelineno-24-4></a><span class=go>rm key</span>
</code></pre></div></td></tr></table></div> </li> <li> <p>Re-enable authentication by running <code>kubectl -n rook-ceph edit cm/rook-config-override</code> and removing auth configuration added in previous steps.</p> </li> <li>Stop the Rook operator by running <code>kubectl -n rook-ceph edit deploy/rook-ceph-operator</code> and set <code>replicas</code> to <code>0</code>.</li> <li>Shut down entire new cluster by running <code>kubectl -n rook-ceph delete deploy/X</code> where X is every deployment in namespace <code>rook-ceph</code>, except <code>rook-ceph-operator</code> and <code>rook-ceph-tools</code>, again. This time OSD daemons are present and should be removed too.</li> <li>Bring the Rook Ceph operator back online by running <code>kubectl -n rook-ceph edit deploy/rook-ceph-operator</code> and set <code>replicas</code> to <code>1</code>.</li> <li>Watch the operator logs with <code>kubectl -n rook-ceph logs -f rook-ceph-operator-xxxxxxx</code>, and wait until the orchestration has settled.</li> <li><strong>STATE</strong>: Now the new cluster should be up and running with authentication enabled. <code>ceph -s</code> output should not change much comparing to previous steps.</li> </ol> <h2 id=backing-up-and-restoring-a-cluster-based-on-pvcs-into-a-new-kubernetes-cluster>Backing up and restoring a cluster based on PVCs into a new Kubernetes cluster<a class=headerlink href=#backing-up-and-restoring-a-cluster-based-on-pvcs-into-a-new-kubernetes-cluster title="Permanent link">&para;</a></h2> <p>It is possible to migrate/restore an rook/ceph cluster from an existing Kubernetes cluster to a new one without resorting to SSH access or ceph tooling. This allows doing the migration using standard kubernetes resources only. This guide assumes the following:</p> <ol> <li>You have a CephCluster that uses PVCs to persist mon and osd data. Let's call it the "old cluster"</li> <li>You can restore the PVCs as-is in the new cluster. Usually this is done by taking regular snapshots of the PVC volumes and using a tool that can re-create PVCs from these snapshots in the underlying cloud provider. <a href=https://github.com/vmware-tanzu/velero>Velero</a> is one such tool.</li> <li>You have regular backups of the secrets and configmaps in the rook-ceph namespace. Velero provides this functionality too.</li> </ol> <p>Do the following in the new cluster:</p> <ol> <li>Stop the rook operator by scaling the deployment <code>rook-ceph-operator</code> down to zero: <code>kubectl -n rook-ceph scale deployment rook-ceph-operator --replicas 0</code> and deleting the other deployments. An example command to do this is <code>k -n rook-ceph delete deployment -l operator!=rook</code></li> <li>Restore the rook PVCs to the new cluster.</li> <li>Copy the keyring and fsid secrets from the old cluster: <code>rook-ceph-mgr-a-keyring</code>, <code>rook-ceph-mon</code>, <code>rook-ceph-mons-keyring</code>, <code>rook-ceph-osd-0-keyring</code>, ...</li> <li>Delete mon services and copy them from the old cluster: <code>rook-ceph-mon-a</code>, <code>rook-ceph-mon-b</code>, ... Note that simply re-applying won't work because the goal here is to restore the <code>clusterIP</code> in each service and this field is immutable in <code>Service</code> resources.</li> <li>Copy the endpoints configmap from the old cluster: <code>rook-ceph-mon-endpoints</code></li> <li>Scale the rook operator up again : <code>kubectl -n rook-ceph scale deployment rook-ceph-operator --replicas 1</code></li> <li>Wait until the reconciliation is over.</li> </ol> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top data-md-state=hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../openshift-common-issues/ class="md-footer__link md-footer__link--prev" aria-label="Previous: OpenShift Common Issues" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> OpenShift Common Issues </div> </div> </a> <a href=../direct-tools/ class="md-footer__link md-footer__link--next" aria-label="Next: Direct Tools" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Direct Tools </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> <a href=/ class=logo> <img src=https://rook.io/images/rook-logo-small.svg alt="rook.io logo"> </a> <p> &#169; Rook Authors 2022. Documentation distributed under <a href=https://creativecommons.org/licenses/by/4.0>CC-BY-4.0</a>. </p> <p> &#169; 2022 The Linux Foundation. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href=https://www.linuxfoundation.org/trademark-usage/ >Trademark Usage</a> page. </p> </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://slack.rook.io/ target=_blank rel=noopener title=slack.rook.io class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M94.12 315.1c0 25.9-21.16 47.06-47.06 47.06S0 341 0 315.1c0-25.9 21.16-47.06 47.06-47.06h47.06v47.06zm23.72 0c0-25.9 21.16-47.06 47.06-47.06s47.06 21.16 47.06 47.06v117.84c0 25.9-21.16 47.06-47.06 47.06s-47.06-21.16-47.06-47.06V315.1zm47.06-188.98c-25.9 0-47.06-21.16-47.06-47.06S139 32 164.9 32s47.06 21.16 47.06 47.06v47.06H164.9zm0 23.72c25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06H47.06C21.16 243.96 0 222.8 0 196.9s21.16-47.06 47.06-47.06H164.9zm188.98 47.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06h-47.06V196.9zm-23.72 0c0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06V79.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06V196.9zM283.1 385.88c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06v-47.06h47.06zm0-23.72c-25.9 0-47.06-21.16-47.06-47.06 0-25.9 21.16-47.06 47.06-47.06h117.84c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06H283.1z"/></svg> </a> <a href=https://twitter.com/rook_io target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> <a href=https://groups.google.com/forum/#!forum/rook-dev target=_blank rel=noopener title=groups.google.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M191.9 448.6a47.726 47.726 0 0 1-27.78-8.891L32 340.2V480c0 17.62 14.38 32 32 32h256c17.62 0 32-14.38 32-32V340.2l-131.8 99.3a48.4 48.4 0 0 1-28.3 9.1zM192 192c0-35.25 28.75-64 64-64h224V32c0-17.62-14.38-32-32-32H128c-17.6 0-32 14.38-32 32v192h96v-32zm128 64H64c-17.62 0-32 14.4-32 32v12.18l151 113.8c5.25 3.719 12.7 3.734 18.27-.25L352 300.2V288c0-17.6-14.4-32-32-32zm256-96H256c-17.6 0-32 14.4-32 32v32h96c33.25 0 60.63 25.38 63.75 57.88L384 416h192c17.62 0 32-14.38 32-32V192c0-17.6-14.4-32-32-32zm-32 128h-64v-64h64v64z"/></svg> </a> <a href=https://blog.rook.io/ target=_blank rel=noopener title=blog.rook.io class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M180.5 74.262C80.813 74.262 0 155.633 0 256s80.819 181.738 180.5 181.738S361 356.373 361 256 280.191 74.262 180.5 74.262Zm288.25 10.646c-49.845 0-90.245 76.619-90.245 171.095s40.406 171.1 90.251 171.1 90.251-76.619 90.251-171.1H559c0-94.503-40.4-171.095-90.248-171.095Zm139.506 17.821c-17.526 0-31.735 68.628-31.735 153.274s14.2 153.274 31.735 153.274S640 340.631 640 256c0-84.649-14.215-153.271-31.742-153.271Z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["content.tabs.link", "instant", "navigation.expand", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "tabs"], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": {"default": "latest-release", "provider": "mike"}}</script> <script src=../../assets/javascripts/bundle.a6c66575.min.js></script> </body> </html>