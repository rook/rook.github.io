












































<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />

    

    <title>Ceph Docs</title>

    <link rel="canonical" href="https://rook.io/docs/rook/v1.9/ceph-kms.html">

    <link rel="icon" href="/favicon.ico" />
<link rel="icon" type="image/png" href="/images/favicon_16x16.png" sizes="16x16" />
<link rel="icon" type="image/png" href="/images/favicon_32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="/images/favicon_48x48.png" sizes="48x48" />
<link rel="icon" type="image/png" href="/images/favicon_192x192.png" sizes="192x192" />


    <link href="//fonts.googleapis.com/css?family=Montserrat:500|Open+Sans:300,400,600" rel="stylesheet">
    
    <link rel="stylesheet" href="/css/main.css">
    
      <link rel="stylesheet" href="/css/docs.css" />
    
  </head>
  <body>
    <nav id="navigation" aria-label="Navigation">
  <div>
    <div class="logo">
      <a href="/"><img src="/images/rook-logo.svg"/></a>
    </div>
    <div
      class="hamburger-controls"
      onclick="if (document.body.classList.contains('menu-open')) { document.body.classList.remove('menu-open') } else { document.body.classList.add('menu-open') }; return false;">
      <span></span> <span></span> <span></span>
    </div>
    <ul class="links">
      <li class="dropdown">
        <a role="button" href="javascript:void(0)">Documentation</a>
        <div class="dropdown-content">
          <a href="/docs/rook/v1.9/">Ceph</a>
          <a href="/docs/cassandra/v1.7/">Cassandra</a>
          <a href="/docs/nfs/v1.7/">NFS</a>
        </div>
      <li class="dropdown">
        <a role="button" href="javascript:void(0)">Community</a>
        <div class="dropdown-content">
          <a href="//github.com/rook/rook">GitHub</a>
          <a href="//slack.rook.io/">Slack</a>
          <a href="//groups.google.com/forum/#!forum/rook-dev">Forum</a>
          <a href="//twitter.com/rook_io">Twitter</a>
        </div>
      </li>
      <li><a href="//blog.rook.io/">Blog</a></li>
      <li><a class="button small" href="/docs/rook/v1.9/quickstart.html">Get Started</a></li>
    </ul>
  </div>
</nav>

    <main id="content" aria-label="Content"><div>



















<section class="docs-header">
  <h1>Ceph</h1>
  <div class="versions">
    <a role="button" href="javascript:void(0)">Rook Ceph v1.9</a>
    <div class="versions-dropdown-content">
      
        <a href="/docs/rook/v1.9/ceph-kms.html" class="active">Rook Ceph v1.9</a>
      
        <a href="/docs/rook/v1.8/ceph-kms.html">Rook Ceph v1.8</a>
      
        <a href="/docs/rook/v1.7/ceph-kms.html">Rook Ceph v1.7</a>
      
        <a href="/docs/rook/v1.6/ceph-kms.html">Rook Ceph v1.6</a>
      
        <a href="/docs/rook/v1.5/ceph-kms.html">Rook Ceph v1.5</a>
      
        <a href="/docs/rook/v1.4/ceph-kms.html">Rook Ceph v1.4</a>
      
        <a href="/docs/rook/v1.3/ceph-kms.html">Rook Ceph v1.3</a>
      
        <a href="/docs/rook/v1.2/ceph-kms.html">Rook Ceph v1.2</a>
      
        <a href="/docs/rook/v1.1/ceph-kms.html">Rook Ceph v1.1</a>
      
        <a href="/docs/rook/v1.0/ceph-kms.html">Rook Ceph v1.0</a>
      
        <a href="/docs/rook/v0.9/ceph-kms.html">Rook Ceph v0.9</a>
      
        <a href="/docs/rook/v0.8/ceph-kms.html">Rook Ceph v0.8</a>
      
        <a href="/docs/rook/v0.7/ceph-kms.html">Rook Ceph v0.7</a>
      
        <a href="/docs/rook/v0.6/ceph-kms.html">Rook Ceph v0.6</a>
      
        <a href="/docs/rook/v0.5/ceph-kms.html">Rook Ceph v0.5</a>
      
        <a href="/docs/rook/latest/ceph-kms.html">Rook Ceph latest</a>
      
    </div>
    <img src="/images/arrow.svg" />
  </div>
</section>
<div class="page">
  <div class="docs-menu">
      <ul id="docs-ul"></ul>
  </div>
  <div class="docs-content">
    <div class="docs-actions">
      <a id="edit" href="https://github.com/rook/rook/blob/master/Documentation/ceph-kms.md">Edit on GitHub</a>
    </div>
    
    <div class="docs-text">
      <h1 id="key-management-system">Key Management System</h1>

<p>Rook has the ability to encrypt OSDs of clusters running on PVC via the flag (<code class="language-plaintext highlighter-rouge">encrypted: true</code>) in your <code class="language-plaintext highlighter-rouge">storageClassDeviceSets</code> <a href="#pvc-based-cluster">template</a>.
By default, the Key Encryption Keys (also known as Data Encryption Keys) are stored in a Kubernetes Secret.
However, if a Key Management System exists Rook is capable of using it.</p>

<p>The <code class="language-plaintext highlighter-rouge">security</code> section contains settings related to encryption of the cluster.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">security</code>:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">kms</code>: Key Management System settings
        <ul>
          <li><code class="language-plaintext highlighter-rouge">connectionDetails</code>: the list of parameters representing kms connection details</li>
          <li><code class="language-plaintext highlighter-rouge">tokenSecretName</code>: the name of the Kubernetes Secret containing the kms authentication token</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>Supported KMS providers:</p>

<ul>
  <li><a href="#vault">Vault</a></li>
  <li><a href="#ibm-kp">IBM Key Protect</a></li>
</ul>

<h2 id="vault">Vault</h2>

<p>Rook supports storing OSD encryption keys in <a href="https://www.vaultproject.io/">HashiCorp Vault KMS</a>.</p>

<h3 id="authentication-methods">Authentication methods</h3>

<p>Rook support two authentication methods:</p>

<ul>
  <li><a href="#token-based-authentication">token-based</a>: a token is provided by the user and is stored in a Kubernetes Secret. It’s used to
authenticate the KMS by the Rook operator. This has several pitfalls such as:
    <ul>
      <li>when the token expires it must be renewed, so the secret holding it must be updated</li>
      <li>no token automatic rotation</li>
    </ul>
  </li>
  <li><a href="#kubernetes-based-authentication">Kubernetes Service Account</a> uses <a href="https://www.vaultproject.io/docs/auth/kubernetes">Vault Kubernetes native
authentication</a> mechanism and alleviate some of the limitations from the token authentication such as token automatic renewal. This method is
generally recommended over the token-based authentication.</li>
</ul>

<h4 id="token-based-authentication">Token-based authentication</h4>

<p>When using the token-based authentication, a Kubernetes Secret must be created to hold the token.
This is governed by the <code class="language-plaintext highlighter-rouge">tokenSecretName</code> parameter.</p>

<p>Note: Rook supports <strong>all</strong> the Vault <a href="https://www.vaultproject.io/docs/commands#environment-variables">environment variables</a>.</p>

<p>The Kubernetes Secret <code class="language-plaintext highlighter-rouge">rook-vault-token</code> should contain:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Secret</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">rook-vault-token</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">rook-ceph</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">token</span><span class="pi">:</span> <span class="s">&lt;TOKEN&gt;</span> <span class="c1"># base64 of a token to connect to Vault, for example: cy5GWXpsbzAyY2duVGVoRjhkWG5Bb3EyWjkK</span>
</code></pre></div></div>

<p>You can create a token in Vault by running the following command:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">vault token create -policy=rook
</span></code></pre></div></div>

<p>Refer to the official vault document for more details on <a href="https://www.vaultproject.io/docs/commands/token/create">how to create a
token</a>. For which policy to apply see the
next section.</p>

<p>In order for Rook to connect to Vault, you must configure the following in your <code class="language-plaintext highlighter-rouge">CephCluster</code> template:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">security</span><span class="pi">:</span>
  <span class="na">kms</span><span class="pi">:</span>
    <span class="c1"># name of the k8s config map containing all the kms connection details</span>
    <span class="na">connectionDetails</span><span class="pi">:</span>
      <span class="na">KMS_PROVIDER</span><span class="pi">:</span> <span class="s">vault</span>
      <span class="na">VAULT_ADDR</span><span class="pi">:</span> <span class="s">https://vault.default.svc.cluster.local:8200</span>
      <span class="na">VAULT_BACKEND_PATH</span><span class="pi">:</span> <span class="s">rook</span>
      <span class="na">VAULT_SECRET_ENGINE</span><span class="pi">:</span> <span class="s">kv</span>
      <span class="na">VAULT_AUTH_METHOD</span><span class="pi">:</span> <span class="s">token</span>
    <span class="c1"># name of the k8s secret containing the kms authentication token</span>
    <span class="na">tokenSecretName</span><span class="pi">:</span> <span class="s">rook-vault-token</span>
</code></pre></div></div>

<h4 id="kubernetes-based-authentication">Kubernetes-based authentication</h4>

<p>In order to use the Kubernetes Service Account authentication method, the following must be run to properly configure Vault:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">ROOK_NAMESPACE</span><span class="o">=</span>rook-ceph
<span class="nv">ROOK_VAULT_SA</span><span class="o">=</span>rook-vault-auth
<span class="nv">ROOK_SYSTEM_SA</span><span class="o">=</span>rook-ceph-system
<span class="nv">ROOK_OSD_SA</span><span class="o">=</span>rook-ceph-osd
<span class="nv">VAULT_POLICY_NAME</span><span class="o">=</span>rook

<span class="c"># create service account for vault to validate API token</span>
kubectl <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$ROOK_NAMESPACE</span><span class="s2">"</span> create serviceaccount <span class="s2">"</span><span class="nv">$ROOK_VAULT_SA</span><span class="s2">"</span>

<span class="c"># create the RBAC for this SA</span>
kubectl <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$ROOK_NAMESPACE</span><span class="s2">"</span> create clusterrolebinding vault-tokenreview-binding <span class="nt">--clusterrole</span><span class="o">=</span>system:auth-delegator <span class="nt">--serviceaccount</span><span class="o">=</span><span class="s2">"</span><span class="nv">$ROOK_NAMESPACE</span><span class="s2">"</span>:<span class="s2">"</span><span class="nv">$ROOK_VAULT_SA</span><span class="s2">"</span>

<span class="c"># get the service account common.yaml created earlier</span>
<span class="nv">VAULT_SA_SECRET_NAME</span><span class="o">=</span><span class="si">$(</span>kubectl <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$ROOK_NAMESPACE</span><span class="s2">"</span> get sa <span class="s2">"</span><span class="nv">$ROOK_VAULT_SA</span><span class="s2">"</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.secrets[*]['name']}"</span><span class="si">)</span>

<span class="c"># Set SA_JWT_TOKEN value to the service account JWT used to access the TokenReview API</span>
<span class="nv">SA_JWT_TOKEN</span><span class="o">=</span><span class="si">$(</span>kubectl <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$ROOK_NAMESPACE</span><span class="s2">"</span> get secret <span class="s2">"</span><span class="nv">$VAULT_SA_SECRET_NAME</span><span class="s2">"</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.data.token}"</span> | <span class="nb">base64</span> <span class="nt">--decode</span><span class="si">)</span>

<span class="c"># Set SA_CA_CRT to the PEM encoded CA cert used to talk to Kubernetes API</span>
<span class="nv">SA_CA_CRT</span><span class="o">=</span><span class="si">$(</span>kubectl <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$ROOK_NAMESPACE</span><span class="s2">"</span> get secret <span class="s2">"</span><span class="nv">$VAULT_SA_SECRET_NAME</span><span class="s2">"</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.data['ca</span><span class="se">\.</span><span class="s2">crt']}"</span> | <span class="nb">base64</span> <span class="nt">--decode</span><span class="si">)</span>

<span class="c"># get kubernetes endpoint</span>
<span class="nv">K8S_HOST</span><span class="o">=</span><span class="si">$(</span>kubectl config view <span class="nt">--minify</span> <span class="nt">--flatten</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.clusters[0].cluster.server}"</span><span class="si">)</span>

<span class="c"># enable kubernetes auth</span>
vault auth <span class="nb">enable </span>kubernetes

<span class="c"># To fetch the service account issuer</span>
kubectl proxy &amp;
<span class="nv">proxy_pid</span><span class="o">=</span><span class="nv">$!</span>

<span class="c"># configure the kubernetes auth</span>
vault write auth/kubernetes/config <span class="se">\</span>
    <span class="nv">token_reviewer_jwt</span><span class="o">=</span><span class="s2">"</span><span class="nv">$SA_JWT_TOKEN</span><span class="s2">"</span> <span class="se">\</span>
    <span class="nv">kubernetes_host</span><span class="o">=</span><span class="s2">"</span><span class="nv">$K8S_HOST</span><span class="s2">"</span> <span class="se">\</span>
    <span class="nv">kubernetes_ca_cert</span><span class="o">=</span><span class="s2">"</span><span class="nv">$SA_CA_CRT</span><span class="s2">"</span> <span class="se">\</span>
    <span class="nv">issuer</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span>curl <span class="nt">--silent</span> http://127.0.0.1:8001/.well-known/openid-configuration | jq <span class="nt">-r</span> .issuer<span class="si">)</span><span class="s2">"</span>

<span class="nb">kill</span> <span class="nv">$proxy_pid</span>

<span class="c"># configure a role for rook</span>
vault write auth/kubernetes/role/<span class="s2">"</span><span class="nv">$ROOK_NAMESPACE</span><span class="s2">"</span> <span class="se">\</span>
    <span class="nv">bound_service_account_names</span><span class="o">=</span><span class="s2">"</span><span class="nv">$ROOK_SYSTEM_SA</span><span class="s2">"</span>,<span class="s2">"</span><span class="nv">$ROOK_OSD_SA</span><span class="s2">"</span> <span class="se">\</span>
    <span class="nv">bound_service_account_namespaces</span><span class="o">=</span><span class="s2">"</span><span class="nv">$ROOK_NAMESPACE</span><span class="s2">"</span> <span class="se">\</span>
    <span class="nv">policies</span><span class="o">=</span><span class="s2">"</span><span class="nv">$VAULT_POLICY_NAME</span><span class="s2">"</span> <span class="se">\</span>
    <span class="nv">ttl</span><span class="o">=</span>1440h
</code></pre></div></div>

<p>Once done, your <code class="language-plaintext highlighter-rouge">CephCluster</code> CR should look like:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">security</span><span class="pi">:</span>
  <span class="na">kms</span><span class="pi">:</span>
    <span class="na">connectionDetails</span><span class="pi">:</span>
        <span class="na">KMS_PROVIDER</span><span class="pi">:</span> <span class="s">vault</span>
        <span class="na">VAULT_ADDR</span><span class="pi">:</span> <span class="s">https://vault.default.svc.cluster.local:8200</span>
        <span class="na">VAULT_BACKEND_PATH</span><span class="pi">:</span> <span class="s">rook</span>
        <span class="na">VAULT_SECRET_ENGINE</span><span class="pi">:</span> <span class="s">kv</span>
        <span class="na">VAULT_AUTH_METHOD</span><span class="pi">:</span> <span class="s">kubernetes</span>
        <span class="na">VAULT_AUTH_KUBERNETES_ROLE</span><span class="pi">:</span> <span class="s">rook-ceph</span>
</code></pre></div></div>

<blockquote>
  <p>Note: The <code class="language-plaintext highlighter-rouge">VAULT_ADDR</code> value above assumes that Vault is accessible within the cluster itself on the default port (8200). If running elsewhere, please update the URL accordingly.</p>
</blockquote>

<h3 id="general-vault-configuration">General Vault configuration</h3>

<p>As part of the token, here is an example of a policy that can be used:</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">path</span> <span class="s2">"rook/*"</span> <span class="p">{</span>
  <span class="nx">capabilities</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"create"</span><span class="p">,</span> <span class="s2">"read"</span><span class="p">,</span> <span class="s2">"update"</span><span class="p">,</span> <span class="s2">"delete"</span><span class="p">,</span> <span class="s2">"list"</span><span class="p">]</span>
<span class="p">}</span>
<span class="nx">path</span> <span class="s2">"sys/mounts"</span> <span class="p">{</span>
<span class="nx">capabilities</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"read"</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>You can write the policy like so and then create a token:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">vault policy write rook /tmp/rook.hcl
vault token create -policy=rook
</span></code></pre></div></div>
<blockquote>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Key                  Value
---                  -----
token                s.FYzlo02cgnTehF8dXnAoq2Z9
token_accessor       oMo7sAXQKbYtxU4HtO8k3pko
token_duration       768h
token_renewable      true
token_policies       ["default" "rook"]
identity_policies    []
policies             ["default" "rook"]
</code></pre></div>  </div>
</blockquote>

<p>In the above example, Vault’s secret backend path name is <code class="language-plaintext highlighter-rouge">rook</code>. It must be enabled with the following:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">vault secrets enable -path=rook kv
</span></code></pre></div></div>

<p>If a different path is used, the <code class="language-plaintext highlighter-rouge">VAULT_BACKEND_PATH</code> key in <code class="language-plaintext highlighter-rouge">connectionDetails</code> must be changed.</p>

<h3 id="tls-configuration">TLS configuration</h3>

<p>This is an advanced but recommended configuration for production deployments, in this case the <code class="language-plaintext highlighter-rouge">vault-connection-details</code> will look like:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">security</span><span class="pi">:</span>
  <span class="na">kms</span><span class="pi">:</span>
    <span class="c1"># name of the k8s config map containing all the kms connection details</span>
    <span class="na">connectionDetails</span><span class="pi">:</span>
      <span class="na">KMS_PROVIDER</span><span class="pi">:</span> <span class="s">vault</span>
      <span class="na">VAULT_ADDR</span><span class="pi">:</span> <span class="s">https://vault.default.svc.cluster.local:8200</span>
      <span class="na">VAULT_CACERT</span><span class="pi">:</span> <span class="s">&lt;name of the k8s secret containing the PEM-encoded CA certificate&gt;</span>
      <span class="na">VAULT_CLIENT_CERT</span><span class="pi">:</span> <span class="s">&lt;name of the k8s secret containing the PEM-encoded client certificate&gt;</span>
      <span class="na">VAULT_CLIENT_KEY</span><span class="pi">:</span> <span class="s">&lt;name of the k8s secret containing the PEM-encoded private key&gt;</span>
    <span class="c1"># name of the k8s secret containing the kms authentication token</span>
    <span class="na">tokenSecretName</span><span class="pi">:</span> <span class="s">rook-vault-token</span>
</code></pre></div></div>

<p>Each secret keys are expected to be:</p>

<ul>
  <li>VAULT_CACERT: <code class="language-plaintext highlighter-rouge">cert</code></li>
  <li>VAULT_CLIENT_CERT: <code class="language-plaintext highlighter-rouge">cert</code></li>
  <li>VAULT_CLIENT_KEY: <code class="language-plaintext highlighter-rouge">key</code></li>
</ul>

<p>For instance <code class="language-plaintext highlighter-rouge">VAULT_CACERT</code> Secret named <code class="language-plaintext highlighter-rouge">vault-tls-ca-certificate</code> will look like:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Secret</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">vault-tls-ca-certificate</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">rook-ceph</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">cert</span><span class="pi">:</span> <span class="s">&lt;PEM base64 encoded CA certificate&gt;</span>
</code></pre></div></div>

<p>Note: if you are using self-signed certificates (not known/approved by a proper CA) you must pass <code class="language-plaintext highlighter-rouge">VAULT_SKIP_VERIFY: true</code>.
Communications will remain encrypted but the validity of the certificate will not be verified.</p>

<h2 id="ibm-key-protect">IBM Key Protect</h2>

<p>Rook supports storing OSD encryption keys in <a href="https://www.ibm.com/cloud/key-protect">IBM Key
Protect</a>. The current implementation stores OSD encryption
keys as <a href="https://cloud.ibm.com/docs/key-protect?topic=key-protect-envelope-encryption#key-types">Standard Keys</a> using the <a href="https://cloud.ibm.com/docs/key-protect?topic=key-protect-importing-keys">Bring Your Own
Key</a> (BYOK) method. This
means that the Key Protect instance policy must have Standard Imported Key enabled.</p>

<h3 id="configuration">Configuration</h3>

<p>First, you need to <a href="https://cloud.ibm.com/docs/key-protect?topic=key-protect-provision">provision the Key Protect service</a> on the IBM Cloud. Once
completed, <a href="https://cloud.ibm.com/docs/key-protect?topic=key-protect-retrieve-instance-ID&amp;interface=ui">retrieve the instance ID</a>.
Make a record of it; we need it in the CRD.</p>

<p>On the IBM Cloud, the user must create a Service ID, then assign an Access Policy to this service.
Ultimately, a Service API Key needs to be generated. All the steps are summarized in the <a href="https://www.ibm.com/docs/en/cloud-private/3.2.0?topic=dg-creating-service-id-by-using-cloud-private-management-console">official
documentation</a>.</p>

<p>The Service ID must be granted access to the Key Protect Service. Once the Service API Key is
generated, store it in a Kubernetes Secret.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Secret</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ibm-kp-svc-api-key</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">rook-ceph</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">IBM_KP_SERVICE_API_KEY</span><span class="pi">:</span> <span class="s">&lt;service API Key&gt;</span>
</code></pre></div></div>

<p>In order for Rook to connect to IBM Key Protect, you must configure the following in your <code class="language-plaintext highlighter-rouge">CephCluster</code> template:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">security</span><span class="pi">:</span>
  <span class="na">kms</span><span class="pi">:</span>
    <span class="c1"># name of the k8s config map containing all the kms connection details</span>
    <span class="na">connectionDetails</span><span class="pi">:</span>
      <span class="na">KMS_PROVIDER</span><span class="pi">:</span> <span class="s">ibmkeyprotect</span>
      <span class="na">IBM_KP_SERVICE_INSTANCE_ID</span><span class="pi">:</span> <span class="s">&lt;instance ID that was retrieved in the first paragraph&gt;</span>
    <span class="c1"># name of the k8s secret containing the service API Key</span>
    <span class="na">tokenSecretName</span><span class="pi">:</span> <span class="s">ibm-kp-svc-api-key</span>
</code></pre></div></div>

<p>More options are supported such as:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">IBM_BASE_URL</code>: the base URL of the Key Protect instance, depending on your
<a href="https://cloud.ibm.com/docs/key-protect?topic=key-protect-regions">region</a>. Defaults to <code class="language-plaintext highlighter-rouge">https://us-south.kms.cloud.ibm.com</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">IBM_TOKEN_URL</code>: the URL of the Key Protect instance to retrieve the token. Defaults to
<code class="language-plaintext highlighter-rouge">https://iam.cloud.ibm.com/oidc/token</code>. Only needed for private instances.</li>
</ul>

    </div>
  </div>
</div>

<script>
  var menu = [];
  var BASE_PATH = "";

  function add(name, url, isChild, current) {
    var item = { name: name, url: url, current: current };
    var container = menu;
    if (isChild && menu.length > 0) {
      menu[menu.length-1].children = menu[menu.length-1].children || [];
      container = menu[menu.length-1].children;
      if (current) {
        menu[menu.length-1].childCurrent = true;
      }
    }
    container.push(item);
  }

  
    add(
      "Rook",
      "/docs/rook/v1.9/",
      false,
      false
    );
  
    add(
      "Quickstart",
      "/docs/rook/v1.9/quickstart.html",
      false,
      false
    );
  
    add(
      "Prerequisites",
      "/docs/rook/v1.9/pre-reqs.html",
      false,
      false
    );
  
    add(
      "Authenticated Registries",
      "/docs/rook/v1.9/authenticated-registry.html",
      true,
      false
    );
  
    add(
      "Pod Security Policies",
      "/docs/rook/v1.9/pod-security-policies.html",
      true,
      false
    );
  
    add(
      "Ceph Storage",
      "/docs/rook/v1.9/ceph-storage.html",
      false,
      false
    );
  
    add(
      "Examples",
      "/docs/rook/v1.9/ceph-examples.html",
      true,
      false
    );
  
    add(
      "OpenShift",
      "/docs/rook/v1.9/ceph-openshift.html",
      true,
      false
    );
  
    add(
      "Block Storage",
      "/docs/rook/v1.9/ceph-block.html",
      true,
      false
    );
  
    add(
      "Object Storage",
      "/docs/rook/v1.9/ceph-object.html",
      true,
      false
    );
  
    add(
      "Object Multisite",
      "/docs/rook/v1.9/ceph-object-multisite.html",
      true,
      false
    );
  
    add(
      "Shared Filesystem",
      "/docs/rook/v1.9/ceph-filesystem.html",
      true,
      false
    );
  
    add(
      "Ceph Dashboard",
      "/docs/rook/v1.9/ceph-dashboard.html",
      true,
      false
    );
  
    add(
      "Prometheus Monitoring",
      "/docs/rook/v1.9/ceph-monitoring.html",
      true,
      false
    );
  
    add(
      "Cluster CRD",
      "/docs/rook/v1.9/ceph-cluster-crd.html",
      true,
      false
    );
  
    add(
      "Block Pool CRD",
      "/docs/rook/v1.9/ceph-pool-crd.html",
      true,
      false
    );
  
    add(
      "Object Store CRD",
      "/docs/rook/v1.9/ceph-object-store-crd.html",
      true,
      false
    );
  
    add(
      "Object Multisite CRDs",
      "/docs/rook/v1.9/ceph-object-multisite-crd.html",
      true,
      false
    );
  
    add(
      "Object Bucket Claim",
      "/docs/rook/v1.9/ceph-object-bucket-claim.html",
      true,
      false
    );
  
    add(
      "Object Store User CRD",
      "/docs/rook/v1.9/ceph-object-store-user-crd.html",
      true,
      false
    );
  
    add(
      "Bucket Notifications",
      "/docs/rook/v1.9/ceph-object-bucket-notifications.html",
      true,
      false
    );
  
    add(
      "Shared Filesystem CRD",
      "/docs/rook/v1.9/ceph-filesystem-crd.html",
      true,
      false
    );
  
    add(
      "NFS CRD",
      "/docs/rook/v1.9/ceph-nfs-crd.html",
      true,
      false
    );
  
    add(
      "Ceph CSI",
      "/docs/rook/v1.9/ceph-csi-drivers.html",
      true,
      false
    );
  
    add(
      "RBD Mirroring",
      "/docs/rook/v1.9/rbd-mirroring.html",
      true,
      false
    );
  
    add(
      "Failover and Failback",
      "/docs/rook/v1.9/async-disaster-recovery.html",
      true,
      false
    );
  
    add(
      "Snapshots",
      "/docs/rook/v1.9/ceph-csi-snapshot.html",
      true,
      false
    );
  
    add(
      "Volume clone",
      "/docs/rook/v1.9/ceph-csi-volume-clone.html",
      true,
      false
    );
  
    add(
      "Client CRD",
      "/docs/rook/v1.9/ceph-client-crd.html",
      true,
      false
    );
  
    add(
      "RBD Mirror CRD",
      "/docs/rook/v1.9/ceph-rbd-mirror-crd.html",
      true,
      false
    );
  
    add(
      "Filesystem Mirror CRD",
      "/docs/rook/v1.9/ceph-fs-mirror-crd.html",
      true,
      false
    );
  
    add(
      "SubVolume Group CRD",
      "/docs/rook/v1.9/ceph-fs-subvolumegroup.html",
      true,
      false
    );
  
    add(
      "RADOS Namespace CRD",
      "/docs/rook/v1.9/ceph-pool-radosnamespace.html",
      true,
      false
    );
  
    add(
      "Key Management System",
      "/docs/rook/v1.9/ceph-kms.html",
      true,
      true
    );
  
    add(
      "Configuration",
      "/docs/rook/v1.9/ceph-configuration.html",
      true,
      false
    );
  
    add(
      "Upgrades",
      "/docs/rook/v1.9/ceph-upgrade.html",
      true,
      false
    );
  
    add(
      "Cleanup",
      "/docs/rook/v1.9/ceph-teardown.html",
      true,
      false
    );
  
    add(
      "Helm Charts",
      "/docs/rook/v1.9/helm.html",
      false,
      false
    );
  
    add(
      "Ceph Operator",
      "/docs/rook/v1.9/helm-operator.html",
      true,
      false
    );
  
    add(
      "Ceph Cluster",
      "/docs/rook/v1.9/helm-ceph-cluster.html",
      true,
      false
    );
  
    add(
      "Common Issues",
      "/docs/rook/v1.9/common-issues.html",
      false,
      false
    );
  
    add(
      "Ceph Tools",
      "/docs/rook/v1.9/ceph-tools.html",
      false,
      false
    );
  
    add(
      "Toolbox",
      "/docs/rook/v1.9/ceph-toolbox.html",
      true,
      false
    );
  
    add(
      "Common Issues",
      "/docs/rook/v1.9/ceph-common-issues.html",
      true,
      false
    );
  
    add(
      "CSI Common Issues",
      "/docs/rook/v1.9/ceph-csi-troubleshooting.html",
      true,
      false
    );
  
    add(
      "Monitor Health",
      "/docs/rook/v1.9/ceph-mon-health.html",
      true,
      false
    );
  
    add(
      "OSD Management",
      "/docs/rook/v1.9/ceph-osd-mgmt.html",
      true,
      false
    );
  
    add(
      "Direct Tools",
      "/docs/rook/v1.9/direct-tools.html",
      true,
      false
    );
  
    add(
      "Advanced Configuration",
      "/docs/rook/v1.9/ceph-advanced-configuration.html",
      true,
      false
    );
  
    add(
      "OpenShift Common Issues",
      "/docs/rook/v1.9/ceph-openshift-issues.html",
      true,
      false
    );
  
    add(
      "Disaster Recovery",
      "/docs/rook/v1.9/ceph-disaster-recovery.html",
      true,
      false
    );
  
    add(
      "Contributing",
      "/docs/rook/v1.9/development-flow.html",
      false,
      false
    );
  
    add(
      "Developer Environment",
      "/docs/rook/v1.9/development-environment.html",
      true,
      false
    );
  
    add(
      "Storage Providers",
      "/docs/rook/v1.9/storage-providers.html",
      true,
      false
    );
  

  function getEntry(item) {
    var itemDom = document.createElement('li');

    if (item.current) {
      itemDom.innerHTML = item.name;
      itemDom.classList.add('current');
    } else {
      itemDom.innerHTML = '<a href="' + item.url + '">' + item.name + '</a>';
    }

    return itemDom;
  }

  // Flush css changes as explained in: https://stackoverflow.com/a/34726346
  // and more completely: https://stackoverflow.com/a/6956049
  function flushCss(element) {
    element.offsetHeight;
  }

  function addArrow(itemDom) {
    var MAIN_ITEM_HEIGHT = 24;
    var BOTTOM_PADDING = 20;
    var arrowDom = document.createElement('a');
    arrowDom.classList.add('arrow');
    arrowDom.innerHTML = '<img src="' + BASE_PATH + '/images/arrow.svg" />';
    arrowDom.onclick = function(itemDom) {
      return function () {
        // Calculated full height of the opened list
        var fullHeight = MAIN_ITEM_HEIGHT + BOTTOM_PADDING + itemDom.lastChild.clientHeight + 'px';

        itemDom.classList.toggle('open');

        if (itemDom.classList.contains('open')) {
          itemDom.style.height = fullHeight;
        } else {
          // If the list height is auto we have to set it to fullHeight
          // without tranistion before we shrink it to collapsed height
          if (itemDom.style.height === 'auto') {
            itemDom.style.transition = 'none';
            itemDom.style.height = fullHeight;
            flushCss(itemDom);
            itemDom.style.transition = '';
          }
          itemDom.style.height = MAIN_ITEM_HEIGHT + 'px';
        }

        return false;
      };
    }(itemDom);
    itemDom.appendChild(arrowDom);

    if ((item.current && item.children) || item.childCurrent) {
      itemDom.classList.add('open');
      itemDom.style.height = 'auto';
    } else {
      itemDom.style.height = MAIN_ITEM_HEIGHT + 'px';
    }
  }

  var menuDom = document.getElementById('docs-ul');
  for (var i = 0; i < menu.length; i++) {
    var item = menu[i];
    var itemDom = getEntry(item);

    if (item.childCurrent) {
      itemDom.classList.add('childCurrent');
    }

    if (item.children) {
      addArrow(itemDom);
      itemDom.classList.add('children');
      var children = document.createElement('ul');
      for (var j = 0; j < item.children.length; j++) {
        children.appendChild(getEntry(item.children[j]));
      }
      itemDom.appendChild(children);
    }
    menuDom.appendChild(itemDom);
  }
</script>
</div></main>
    <footer id="footer" aria-label="Footer">
  <div class="top">
    <a href="//www.cncf.io">
      <img
        class="cncf"
        src="/images/cncf.png"
        srcset="/images/cncf@2x.png 2x, /images/cncf@3x.png 3x" />
    </a>
    <p>We are a Cloud Native Computing Foundation graduated project.</p>
  </div>
  <div class="middle">
    <div class="grid-center">
      <div class="col_sm-12">
        <span>Getting Started</span>
        <a href="//github.com/rook/rook">GitHub</a>
        <a href="/docs/rook/v1.9/">Documentation</a>
        <a href="//github.com/rook/rook/blob/master/CONTRIBUTING.md#how-to-contribute">How to Contribute</a>
      </div>
      <div class="col_sm-12">
        <span>Community</span>
        <a href="//slack.rook.io/">Slack</a>
        <a href="//twitter.com/rook_io">Twitter</a>
        <a href="//groups.google.com/forum/#!forum/rook-dev">Forum</a>
        <a href="//blog.rook.io/">Blog</a>
      </div>
      <div class="col_sm-12">
        <span>Contact</span>
        <a href="mailto:cncf-rook-info@lists.cncf.io">Email</a>
        <a href="//github.com/rook/rook/issues">Feature request</a>
      </div>
      <div class="col_sm-12">
        <span>Top Contributors</span>
        <a href="//cloudical.io/">Cloudical</a>
        <a href="//cybozu.com">Cybozu, Inc</a>
        <a href="//www.redhat.com">Red Hat</a>
        <a href="//www.suse.com/">SUSE</a>
        <a href="//upbound.io">Upbound</a>
      </div>
    </div>
  </div>
  <div class="bottom">
    <div class="grid-center">
      <div class="col-8">
        <a class="logo" href="/">
          <img src="/images/rook-logo-small.svg" alt="rook.io" />
        </a>
        <p>
          &#169; Rook Authors 2022. Documentation distributed under
          <a href="https://creativecommons.org/licenses/by/4.0">CC-BY-4.0</a>.
        </p>
        <p>
          &#169; 2022 The Linux Foundation. All rights reserved. The Linux Foundation has
          registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our
          <a href="https://www.linuxfoundation.org/trademark-usage/">Trademark Usage</a> page.
        </p>
      </div>
    </div>
  </div>
</footer>


  <script src="/js/anchor.js"></script>
  <script>
    anchors.options = {
      placement: 'right',
      icon: '#',
    }

    document.addEventListener('DOMContentLoaded', function(event) {
      anchors.add('.docs-text h1, .docs-text h2, .docs-text h3, .docs-text h4, .docs-text h5, .docs-text h6');
    });
  </script>




    
  </body>
</html>
